var nr=Object.defineProperty,$r=Object.defineProperties;var Kr=Object.getOwnPropertyDescriptors;var or=Object.getOwnPropertySymbols;var Hr=Object.prototype.hasOwnProperty,Gr=Object.prototype.propertyIsEnumerable;var Bt=(n,e,t)=>e in n?nr(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,x=(n,e)=>{for(var t in e||(e={}))Hr.call(e,t)&&Bt(n,t,e[t]);if(or)for(var t of or(e))Gr.call(e,t)&&Bt(n,t,e[t]);return n},S=(n,e)=>$r(n,Kr(e));var O=(n,e)=>{for(var t in e)nr(n,t,{get:e[t],enumerable:!0})};var s=(n,e,t)=>(Bt(n,typeof e!="symbol"?e+"":e,t),t);import Ft from"bignumber.js";var b={};O(b,{convertFromAndToCurrenciesToSymbolAndSide:()=>zt,convertSymbolAndSideToFromAndToCurrencies:()=>It,convertSymbolAndSideToFromAndToSymbolCurrencies:()=>no,getBaseQuoteCurrenciesBySymbol:()=>Ot});import q from"bignumber.js";var k={};O(k,{hexStringToObject:()=>jr,hexStringToString:()=>sr,hexStringToUint8Array:()=>ir,numberToTokensAmount:()=>re,objectToHexString:()=>Qr,stringToHexString:()=>ar,toFixedBigNumber:()=>H,tokensAmountToNat:()=>Zr,uint8ArrayToHexString:()=>ut});import We from"bignumber.js";import{Buffer as K}from"buffer";var ir=n=>{var t;let e=(t=n.match(/[\da-f]{2}/gi))==null?void 0:t.map(r=>parseInt(r,16));return new Uint8Array(e)},ut=n=>K.from(n).toString("hex"),ar=n=>K.from(n,"utf8").toString("hex"),sr=n=>K.from(ir(n)).toString("utf8"),Qr=n=>ar(JSON.stringify(n)),jr=n=>{try{return JSON.parse(sr(n))}catch(e){return null}},Zr=(n,e)=>new We(n).multipliedBy(10**e).integerValue(),re=(n,e)=>new We(n).integerValue().div(10**e),H=(n,e,t)=>(n=We.isBigNumber(n)?n:new We(n),new We(n.toFixed(e,t)));var we={};O(we,{isArray:()=>Xr,isPlainObject:()=>Yr,isReadonlyArray:()=>Jr});import Vr from"lodash.isplainobject";var Xr=n=>Array.isArray(n),Jr=n=>Array.isArray(n),Yr=n=>Vr(n);var R={};O(R,{ensureNetworksAreSame:()=>eo});var eo=(n,e)=>{if((typeof n=="string"?n:n.atomexNetwork)!==(typeof e=="string"?e:e.atomexNetwork))throw new Error("Networks are different")};var De={};O(De,{capitalize:()=>to,padEnd:()=>oo,padStart:()=>ro});var to=n=>{var e;return n&&((e=n[0])==null?void 0:e.toLocaleUpperCase())+n.slice(1)},cr=(n,e,t,r=" ")=>{if(String.prototype.padStart!==void 0)return n.padStart(t,r);let o=n.length;if(t<=o||r=="")return n;let i=t-o,a=r.repeat(Math.ceil(i/r.length));return a.length>i&&(a=a.slice(0,i)),e?a+n:n+a},ro=(n,e,t=" ")=>String.prototype.padStart!==void 0?n.padStart(e,t):cr(n,!0,e,t),oo=(n,e,t=" ")=>String.prototype.padEnd!==void 0?n.padEnd(e,t):cr(n,!1,e,t);var Tn=n=>new Promise(e=>setTimeout(e,n)),Et=n=>Math.min(n,2147483647);var Ot=n=>{let e=n.split("/",2);return[e[0]||"",e[1]||""]},no=(n,e,t,r,o=!0)=>{let i=k.toFixedBigNumber(r,n.decimals.price,q.ROUND_FLOOR),[a,c]=Ot(n.name),m=e==="Buy",d,l;o?(d=k.toFixedBigNumber(t,n.decimals.baseCurrency,q.ROUND_FLOOR),l=k.toFixedBigNumber(i.multipliedBy(d),n.decimals.quoteCurrency,m?q.ROUND_CEIL:q.ROUND_FLOOR)):(l=k.toFixedBigNumber(t,n.decimals.quoteCurrency,q.ROUND_FLOOR),d=k.toFixedBigNumber(l.div(i),n.decimals.baseCurrency,m?q.ROUND_FLOOR:q.ROUND_CEIL));let p=k.toFixedBigNumber(new q(1).div(i),n.decimals.price,q.ROUND_FLOOR),v={currencyId:a,amount:d,price:i},P={currencyId:c,amount:l,price:p};return m?[P,v]:[v,P]},It=(n,e)=>{let t,r;if(typeof n=="string"){let o=Ot(n);t=o[0],r=o[1]}else t=n.baseCurrency,r=n.quoteCurrency;return e==="Sell"?[r,t]:[t,r]},zt=(n,e,t)=>{let r=`${e}/${t}`,o=`${t}/${e}`,i,a="Sell";if(we.isReadonlyArray(n))for(let c of n){if(c.name===r){i=c;break}if(c.name===o){i=c,a="Buy";break}}else i=n.get(r),i||(a="Buy",i=n.get(o));if(!i)throw new Error(`Invalid pair: ${e}/${t}`);return[i,a]};var B={};O(B,{isNormalizedOrderPreviewParameters:()=>ao,isOrderPreview:()=>io,normalizeOrderPreviewParameters:()=>so});var io=n=>typeof n.symbol=="string"&&typeof n.side=="string"&&!!n.from&&!!n.to,ao=n=>!!(n.symbol&&n.side&&n.from&&n.to&&typeof n.isBaseCurrencyAmount=="boolean"&&typeof n.isFromAmount=="boolean"),so=(n,e)=>{let t=e.getSymbolsMap(),r,o,i,a=!0,c,m,d=!0;if(n.symbol&&n.side){if(r=n.symbol,o=t.get(r),!o)throw new Error(`The ${r} Symbol not found`);i=n.side,n.isBaseCurrencyAmount!==void 0&&n.isBaseCurrencyAmount!==null&&(a=n.isBaseCurrencyAmount),[c,m]=It(o,i),d=a&&c===o.baseCurrency||!a&&m===o.baseCurrency}else if(n.from&&n.to)c=n.from,m=n.to,d=n.isFromAmount!==void 0&&n.isFromAmount!==null?n.isFromAmount:!0,[o,i]=zt(t,n.from,n.to),r=o.name,a=d&&n.from===o.baseCurrency||!d&&n.to===o.baseCurrency;else throw new Error("Invalid orderPreviewParameters argument passed");return{type:n.type,amount:n.amount,exchangeSymbol:o,side:i,isBaseCurrencyAmount:a,from:c,to:m,isFromAmount:d}};import{BigNumber as mr}from"bignumber.js";import{nanoid as co}from"nanoid";var oe=(r=>(r[r.Local=1]="Local",r[r.Remote=2]="Remote",r[r.All=3]="All",r))(oe||{});var qe=(r=>(r[r.Local=0]="Local",r[r.Remote=1]="Remote",r[r.SafeMerged=2]="SafeMerged",r))(qe||{});var g=class{constructor(){s(this,"listeners",new Set)}addListener(e){return this.listeners.add(e),this}removeListener(e){return this.listeners.has(e)&&this.listeners.delete(e),this}removeAllListeners(){return this.listeners=new Set,this}emit(...e){!this.listeners.size||(this.listeners.size===1?this.listeners.values().next().value(...e):[...this.listeners].forEach(t=>t(...e)))}};var be=class{constructor(e=1e3){this.latencyMs=e;s(this,"watcherIdsMap",new Map);s(this,"internalEmitter",new g)}addListener(e){return this.internalEmitter.addListener(e),this}removeListener(e){return this.internalEmitter.removeListener(e),this}removeAllListeners(){return this.internalEmitter.removeAllListeners(),this}emit(e,...t){let r=this.watcherIdsMap.get(e);r&&clearTimeout(r);let o=setTimeout(()=>{this.watcherIdsMap.delete(e),this.internalEmitter.emit(...t)},this.latencyMs);this.watcherIdsMap.set(e,o)}};var N=class{constructor(e){this.baseUrl=e}async request(e,t=!0){let r=new URL(e.urlPath,this.baseUrl);e.params&&this.setSearchParams(r,e.params);let o=await fetch(r.toString(),{headers:this.createHeaders(e),method:e.method||"GET",body:e.payload?JSON.stringify(e.payload):void 0});if(!(t&&o.status===404)){if(!o.ok){let i=await o.text();throw Error(i)}return await o.json()}}setSearchParams(e,t){for(let r in t){let o=t[r];o!=null&&e.searchParams.set(r,String(o))}}createHeaders(e){let t={};return e.authToken&&(t.Authorization=`Bearer ${e.authToken}`),e.method==="POST"&&e.payload&&(t["Content-Type"]="application/json"),t}};var Nt=class{constructor(e=Nt.defaultCacheOptions){this.defaultCacheOptions=e;s(this,"cacheMap",new Map)}get(e){let t=this.cacheMap.get(e);return t?(this.getTimeoutAndIsSlidingExpiration(t.options)[1]&&this.set(e,t.value,t.options),t.value):void 0}set(e,t,r=this.defaultCacheOptions){this.delete(e);let[o]=this.getTimeoutAndIsSlidingExpiration(r),i=setTimeout(()=>{this.cacheMap.delete(e)},o),a={value:t,watcherId:i,options:r};this.cacheMap.set(e,a)}delete(e){let t=this.cacheMap.get(e);!t||(clearTimeout(t.watcherId),this.cacheMap.delete(e))}clear(){[...this.cacheMap.keys()].forEach(t=>this.delete(t))}async dispose(){this.clear()}getTimeoutAndIsSlidingExpiration(e){return e.slidingExpirationMs!==void 0?[e.slidingExpirationMs,!0]:[e.absoluteExpirationMs,!1]}},M=Nt;s(M,"defaultCacheOptions",{absoluteExpirationMs:1e3*60*30});var ne=class{constructor(e,t){this.timeouts=e;this.counterExpirationMs=t;s(this,"counterExpirationWatcherId");s(this,"actionWatchers",new Set);s(this,"_counter",0)}get counter(){return this._counter}set counter(e){this._counter=e}async dispose(){this.counterExpirationWatcherId&&clearTimeout(this.counterExpirationWatcherId),this.actionWatchers.forEach(e=>clearTimeout(e))}setTimeout(e){return new Promise(t=>{this.counterExpirationMs&&this.resetCounterExpiration();let r=Math.min(this.counter,this.timeouts.length-1),o=this.timeouts[r],i=setTimeout(async()=>{this.actionWatchers.delete(i),clearTimeout(i),await e(),t()},o);this.actionWatchers.add(i),this.counter++})}resetCounter(){this.counter=0}resetCounterExpiration(){this.counterExpirationWatcherId&&clearTimeout(this.counterExpirationWatcherId),this.counterExpirationWatcherId=setTimeout(()=>{this.resetCounter(),this.counterExpirationWatcherId=void 0},this.counterExpirationMs)}};var ve=class{constructor(e){s(this,"events",{orderUpdated:new g,orderBookSnapshot:new g,orderBookUpdated:new g,topOfBookUpdated:new g});s(this,"authorizationManager");s(this,"exchangeService");s(this,"symbolsProvider");s(this,"orderBookProvider");s(this,"_isStarted",!1);s(this,"topOfBookCache",new M({absoluteExpirationMs:1e3*60}));s(this,"handleExchangeServiceOrderUpdated",e=>{this.events.orderUpdated.emit(e)});s(this,"handleExchangeServiceOrderBookSnapshot",async e=>{this.events.orderBookSnapshot.emit(e)});s(this,"handleExchangeServiceOrderBookUpdated",async e=>{this.events.orderBookUpdated.emit(e)});s(this,"handleExchangeServiceTopOfBookUpdated",e=>{this.events.topOfBookUpdated.emit(e)});this.authorizationManager=e.authorizationManager,this.exchangeService=e.exchangeService,this.symbolsProvider=e.symbolsProvider,this.orderBookProvider=e.orderBookProvider}get isStarted(){return this._isStarted}async start(){this.isStarted||(this.attachEvents(),await this.exchangeService.start(),await this.getSymbols(),this._isStarted=!0)}stop(){!this._isStarted||(this.detachEvents(),this.exchangeService.stop(),this._isStarted=!1)}getOrder(e,t,r=2){return this.exchangeService.getOrder(e,t)}getOrders(e,t,r=2){return this.exchangeService.getOrders(e,t)}async getSymbol(e,t=3){if((t&1)===1){let r=this.symbolsProvider.getSymbol(e);if(r)return r}if((t&2)===2){let r=await this.exchangeService.getSymbols();return this.symbolsProvider.setSymbols(r),this.symbolsProvider.getSymbol(e)}}async getSymbols(e=3){if((e&1)===1){let t=this.symbolsProvider.getSymbols();if(t.length>0)return t}if((e&2)===2){let t=await this.exchangeService.getSymbols();return this.symbolsProvider.setSymbols(t),t}return[]}async getTopOfBook(e,t=3){let r=this.convertToSymbolsArray(e),o=this.getTopOfBookCacheKey(r);if((t&1)===1){let i=this.topOfBookCache.get(o);if(i)return i}if((t&2)===2){let i=await this.exchangeService.getTopOfBook(e);return this.topOfBookCache.set(o,i),i}}async getOrderBook(e){let t;if(typeof e=="string")t=e;else{let o=this.symbolsProvider.getSymbolsMap();t=b.convertFromAndToCurrenciesToSymbolAndSide(o,e.from,e.to)[0].name}if(!t)throw new Error("Invalid Symbol");let r=await this.exchangeService.getOrderBook(t);return r&&this.orderBookProvider.setOrderBook(t,r),r}addOrder(e,t){let r=t.proofsOfFunds?t.proofsOfFunds:this.createProofOfFunds(e,t),o={clientOrderId:t.clientOrderId||co(17),orderBody:t.orderBody,requisites:t.requisites,proofsOfFunds:r};return this.exchangeService.addOrder(e,o)}cancelOrder(e,t){return this.exchangeService.cancelOrder(e,t)}cancelAllOrders(e,t){return this.exchangeService.cancelAllOrders(e,t)}async getOrderPreview(e){if(e.type!=="SolidFillOrKill")throw new Error('Only the "SolidFillOrKill" order type is supported at the current moment');let t=this.normalizeOrderPreviewParametersIfNeeded(e),r=await this.findOrderBookEntry(t.exchangeSymbol,t.side,e.type,t.amount,t.isBaseCurrencyAmount);if(!r)return;let[o,i]=b.convertSymbolAndSideToFromAndToSymbolCurrencies(t.exchangeSymbol,t.side,t.amount,r.price,t.isBaseCurrencyAmount);return{type:e.type,from:o,to:i,side:t.side,symbol:t.exchangeSymbol.name}}async getAvailableLiquidity(e){if(e.type!=="SolidFillOrKill")throw new Error('Only the "SolidFillOrKill" order type is supported at the current moment');let t,r;if(e.symbol!==void 0)t=e.symbol,r=e.side;else{let d=this.symbolsProvider.getSymbolsMap(),l=b.convertFromAndToCurrenciesToSymbolAndSide(d,e.from,e.to);t=l[0].name,r=l[1]}let o=await this.getCachedOrderBook(t);if(!o)return;let i=Math.max(...o.entries.filter(d=>d.side!=r).map(d=>Math.max(...d.qtyProfile)));if(!isFinite(i)||isNaN(i)||i<=0)return;let a=new mr(i),c=e.symbol!==void 0?{amount:a,symbol:t,side:r,type:e.type,isBaseCurrencyAmount:!0}:{amount:a,type:e.type,from:e.from,to:e.to,isFromAmount:r==="Sell"},m=await this.getOrderPreview(c);if(!!m)return{symbol:m.symbol,type:m.type,from:m.from,to:m.to,side:m.side}}attachEvents(){this.exchangeService.events.orderUpdated.addListener(this.handleExchangeServiceOrderUpdated),this.exchangeService.events.orderBookSnapshot.addListener(this.handleExchangeServiceOrderBookSnapshot),this.exchangeService.events.orderBookUpdated.addListener(this.handleExchangeServiceOrderBookUpdated),this.exchangeService.events.topOfBookUpdated.addListener(this.handleExchangeServiceTopOfBookUpdated)}detachEvents(){this.exchangeService.events.orderUpdated.removeListener(this.handleExchangeServiceOrderUpdated),this.exchangeService.events.orderBookSnapshot.removeListener(this.handleExchangeServiceOrderBookSnapshot),this.exchangeService.events.orderBookUpdated.removeListener(this.handleExchangeServiceOrderBookUpdated),this.exchangeService.events.topOfBookUpdated.removeListener(this.handleExchangeServiceTopOfBookUpdated)}normalizeOrderPreviewParametersIfNeeded(e){return B.isNormalizedOrderPreviewParameters(e)?e:B.normalizeOrderPreviewParameters(e,this.symbolsProvider)}async findOrderBookEntry(e,t,r,o,i){if(r!=="SolidFillOrKill")return;let a=await this.getCachedOrderBook(e.name);if(!!a)for(let c of a.entries){if(c.side===t)continue;if((i?o:H(o.div(c.price),e.decimals.baseCurrency,mr.ROUND_FLOOR)).isLessThanOrEqualTo(Math.max(...c.qtyProfile)))return c}}createProofOfFunds(e,t){if(!this.authorizationManager.getAuthToken(e))throw new Error(`Cannot find auth token for address: ${e}`);let o=B.isOrderPreview(t.orderBody)?t.orderBody.from.currencyId:b.convertSymbolAndSideToFromAndToCurrencies(t.orderBody.symbol,t.orderBody.side)[0];return[]}getCachedOrderBook(e){let t=this.orderBookProvider.getOrderBook(e);return t?Promise.resolve(t):this.getOrderBook(e)}getTopOfBookCacheKey(e){let t;return e&&e.length?(e.sort(),t=e.join(",")):t="all",`top-of-book_${t}`}convertToSymbolsArray(e){let t;if(e!=null&&e.length)if(typeof e[0]=="string")t=[...e];else{let r=this.symbolsProvider.getSymbolsMap();t=e.map(o=>b.convertFromAndToCurrenciesToSymbolAndSide(r,o.from,o.to)[0].name)}return t}};var ie=class{constructor(){s(this,"symbolsMap",new Map);s(this,"symbolsCollectionCache",[])}getSymbol(e){return this.symbolsMap.get(e)}getSymbols(){return this.symbolsCollectionCache}getSymbolsMap(){return this.symbolsMap}setSymbols(e){this.symbolsCollectionCache=e,this.symbolsMap=this.mapSymbolsCollectionToMap(e)}mapSymbolsCollectionToMap(e){let t=new Map;for(let r of e)t.set(r.name,r);return t}};var Se=class{constructor(){s(this,"orderBookMap",new Map)}getOrderBook(e){return this.orderBookMap.get(e)}setOrderBook(e,t){this.orderBookMap.set(e,t)}};import mo from"bignumber.js";var ae=class{constructor(e,t){this.currenciesProvider=e;this.providersMap=t;s(this,"cache",new M({absoluteExpirationMs:1e3*30}))}async getAveragePrice({baseCurrency:e,quoteCurrency:t,dataSource:r=3}){let o=this.tryFindCurrency(e),i=this.tryFindCurrency(t),a=this.getCacheKey({isAverage:!0,baseCurrencyOrSymbol:o,quoteCurrencyOrSymbol:i});if((r&1)===1){let c=this.cache.get(a);if(c)return c}if((r&2)===2){let m=this.getAvailableProviders().map(p=>this.getPrice({baseCurrency:o,quoteCurrency:i,provider:p,dataSource:r})),d=await Promise.allSettled(m),l=[];for(let p of d)p.status==="fulfilled"&&p.value!==void 0&&l.push(p.value);if(l.length){let p=mo.sum(...l).div(l.length);return this.cache.set(a,p),p}}}async getPrice({baseCurrency:e,quoteCurrency:t,provider:r,dataSource:o=3}){let i=this.tryFindCurrency(e),a=this.tryFindCurrency(t),c=this.getCacheKey({isAverage:!1,baseCurrencyOrSymbol:i,quoteCurrencyOrSymbol:a,provider:r});if((o&1)===1){let m=this.cache.get(c);if(m)return m}if((o&2)===2){let m=await this.getPriceCore(i,a,r);if(!m){let d=await this.getPriceCore(a,i,r);d&&(m=d.pow(-1))}if(m)return this.cache.set(c,m),m}}getAvailableProviders(){return[...this.providersMap.keys()]}async dispose(){this.cache.clear()}tryFindCurrency(e){return typeof e!="string"?e:this.currenciesProvider.getCurrency(e)||e}getCacheKey({isAverage:e,baseCurrencyOrSymbol:t,quoteCurrencyOrSymbol:r,provider:o}){let i=e?"average":"actual",a=typeof t=="string"?t:t.id,c=typeof r=="string"?r:r.id;return`${i}_${a}_${c}_${o||""}`}async getPriceCore(e,t,r){let i=this.getSelectedProviders(r).map(c=>c.getPrice(e,t)),a=await Promise.allSettled(i);for(let c of a)if(c.status==="fulfilled"&&c.value!==void 0)return c.value}getSelectedProviders(e){if(!e)return[...this.providersMap.values()];let t=this.providersMap.get(e);if(!t)throw new Error(`Provider not found for key: ${e}`);return[t]}};var se=class{constructor(e){this.exchangeManager=e}async getPrice(e,t){var c;let r=this.getSymbol(e),o=this.getSymbol(t),i=`${r}/${o}`,a=(c=await this.exchangeManager.getTopOfBook([{from:r,to:o}],2))==null?void 0:c[0];return a&&a.symbol===i?this.getMiddlePrice(a):void 0}getSymbol(e){return typeof e=="string"?e:e.id}getMiddlePrice(e){return e.ask.plus(e.bid).div(2)}};import lo from"bignumber.js";var dr=n=>{let e=n;return typeof e.code=="number"&&typeof e.msg=="string"};var Ue=class{constructor(){s(this,"httpClient");s(this,"_allSymbols");this.httpClient=new N(Ue.baseUrl)}async getPrice(e,t){let r=this.getSymbol(e),o=this.getSymbol(t),i=`${r}${o}`;if(!(await this.getAllSymbols()).has(i))return;let c=`${Ue.priceUrlPath}?symbol=${i}`,m=await this.httpClient.request({urlPath:c},!1);return this.mapRatesDtoToPrice(m)}getSymbol(e){return(typeof e=="string"?e:e.symbol).toUpperCase()}mapRatesDtoToPrice(e){if(!dr(e))return new lo(e.price)}async getAllSymbols(){return this._allSymbols||(this._allSymbols=new Set(await this.requestAllSymbols())),this._allSymbols}async requestAllSymbols(){let e=Ue.priceUrlPath;return(await this.httpClient.request({urlPath:e},!1)).map(r=>r.symbol)}},U=Ue;s(U,"baseUrl","https://www.binance.com"),s(U,"priceUrlPath","/api/v3/ticker/price");import po from"bignumber.js";var Rt=class{constructor(){s(this,"httpClient");this.httpClient=new N(Rt.baseUrl)}async getPrice(e,t){let r=this.getSymbol(e),o=this.getSymbol(t),a=`/0/public/Ticker?pair=${`${r}${o}`}`,c=await this.httpClient.request({urlPath:a},!1);return this.mapRatesDtoToPrice(c)}getSymbol(e){return(typeof e=="string"?e:e.symbol).toUpperCase()}mapRatesDtoToPrice(e){if(e.error.length)return;let t=Object.keys(e.result)[0],r=t?e.result[t]:void 0;if(!!r)return new po(r.c[0])}},G=Rt;s(G,"baseUrl","https://api.kraken.com");import F from"bignumber.js";var _=class{constructor(e){this.atomexContext=e;s(this,"swapPreviewFeesCache",new M({absoluteExpirationMs:20*1e3}));s(this,"userInvolvedSwapsCache",new M({slidingExpirationMs:30*1e3}))}async getSwapPreview(e){let t=this.normalizeSwapPreviewParametersIfNeeded(e),r=this.getSwapCurrencyInfos(t.from,t.to);return this.getSwapPreviewInternal(t,r)}clearCache(){this.swapPreviewFeesCache.clear(),this.userInvolvedSwapsCache.clear()}async dispose(){this.clearCache()}normalizeSwapPreviewParametersIfNeeded(e){return _.isNormalizedSwapPreviewParameters(e)?e:_.normalizeSwapPreviewParameters(e,this.atomexContext.providers.exchangeSymbolsProvider,{redeemEnabled:!0,refundEnabled:!0})}getSwapCurrencyInfos(e,t){let r=this.atomexContext.providers.blockchainProvider.getCurrencyInfo(e);if(!r)throw new Error(`The "${e}" currency (from) is unknown`);let o=this.atomexContext.providers.blockchainProvider.getCurrencyInfo(t);if(!o)throw new Error(`The "${t}" currency (to) is unknown`);let i=this.atomexContext.providers.blockchainProvider.getNativeCurrencyInfo(r.currency.blockchain);if(!i)throw new Error(`The "${r.currency.id}" currency is a currency of unknown blockchain: ${r.currency.blockchain}`);let a=this.atomexContext.providers.blockchainProvider.getNativeCurrencyInfo(o.currency.blockchain);if(!a)throw new Error(`The "${o.currency.id}" currency is a currency of unknown blockchain: ${o.currency.blockchain}`);return{fromCurrencyInfo:r,fromNativeCurrencyInfo:i,toCurrencyInfo:o,toNativeCurrencyInfo:a,isFromCurrencyNative:r.currency.id===i.currency.id,isToCurrencyNative:o.currency.id===a.currency.id}}async getSwapPreviewInternal(e,t){let r=await this.atomexContext.managers.exchangeManager.getAvailableLiquidity({type:e.type,symbol:e.exchangeSymbol.name,side:e.side});if(!r)throw new Error(`No available liquidity for the "${e.exchangeSymbol.name}" symbol`);let o=[],i=[],a=await this.atomexContext.managers.exchangeManager.getOrderPreview(e);a||o.push({id:"not-enough-liquidity"});let c=await this.calculateSwapPreviewFees(t,e.watchTower),m=await this.getSwapPreviewAccountData(e,a,r,t,c,o,i);return{type:e.type,from:{currencyId:e.from,price:a?a.from.price:r.from.price,address:m.fromAddress,actual:a?{amount:a.from.amount,price:a.from.price}:{amount:e.isFromAmount?e.amount:new F(0),price:new F(0)},available:{amount:r.from.amount,price:r.from.price},max:m.maxOrderPreview&&{amount:m.maxOrderPreview.from.amount,price:m.maxOrderPreview.from.price}},to:{currencyId:e.to,price:a?a.to.price:r.to.price,address:m.toAddress,actual:a?{amount:a.to.amount,price:a.to.price}:{amount:e.isFromAmount?new F(0):e.amount,price:new F(0)},available:{amount:r.to.amount,price:r.to.price},max:m.maxOrderPreview&&{amount:m.maxOrderPreview.to.amount,price:m.maxOrderPreview.to.price}},symbol:e.exchangeSymbol.name,side:e.side,fees:c,errors:o,warnings:i}}async getSwapPreviewAccountData(e,t,r,o,i,a,c){var T;let[m,d]=await Promise.all([this.atomexContext.managers.walletsManager.getWallet(void 0,o.fromCurrencyInfo.currency.blockchain).then(h=>h==null?void 0:h.getAddress()),this.atomexContext.managers.walletsManager.getWallet(void 0,o.toCurrencyInfo.currency.blockchain).then(h=>h==null?void 0:h.getAddress())]),l,p=m&&this.atomexContext.managers.authorizationManager.getAuthToken(m)?m:void 0,v=d&&this.atomexContext.managers.authorizationManager.getAuthToken(d)?d:void 0,P=await this.getUserInvolvedSwapsInfo(p,v,o);if(p){let h=await this.atomexContext.managers.balanceManager.getBalance(p,o.fromCurrencyInfo.currency),y=o.isFromCurrencyNative?h:await this.atomexContext.managers.balanceManager.getBalance(p,o.fromNativeCurrencyInfo.currency);if(!h||!y)throw new Error("Can not get from currency balances");let w=h,C=_.calculateMaxTotalFee(i,o.fromNativeCurrencyInfo.currency.id);if(y=y.minus(C),y.isLessThanOrEqualTo(0))a.push({id:"not-enough-funds",data:{type:"fees",currencyId:o.fromNativeCurrencyInfo.currency.id,requiredAmount:C}});else if(P){let f=P[o.fromNativeCurrencyInfo.currency.id];f&&(y=y.minus(f.lockedAmount),y.isLessThanOrEqualTo(0)&&a.push({id:"not-enough-funds",data:{type:"swaps",currencyId:f.currencyId,swapIds:f.swapIds,lockedAmount:f.lockedAmount}}))}if(o.isFromCurrencyNative)h=y;else if(h.isLessThanOrEqualTo(0))a.push({id:"not-enough-funds",data:{type:"balance",currencyId:(t==null?void 0:t.from.currencyId)||r.from.currencyId,requiredAmount:(t==null?void 0:t.from.amount)||r.from.amount}});else if(P){let f=P[o.fromCurrencyInfo.currency.id];f&&(h=h.minus(f.lockedAmount),h.isLessThanOrEqualTo(0)&&a.push({id:"not-enough-funds",data:{type:"swaps",currencyId:f.currencyId,swapIds:f.swapIds,lockedAmount:f.lockedAmount}}))}if(l=h.isGreaterThan(0)?await this.getMaxOrderPreview(h,r):void 0,l&&t&&t.from.amount.isGreaterThan(l.from.amount)){if(t.from.amount.isGreaterThan(w))a.push({id:"not-enough-funds",data:{type:"balance",currencyId:t.from.currencyId,requiredAmount:t.from.amount.minus(l.from.amount)}});else if(P){let f=P[o.fromCurrencyInfo.currency.id];f&&a.push({id:"not-enough-funds",data:{type:"swaps",swapIds:f.swapIds,currencyId:f.currencyId,lockedAmount:f.lockedAmount}})}}}if(v){let h=await this.atomexContext.managers.balanceManager.getBalance(v,o.toNativeCurrencyInfo.currency);if(!h)throw new Error("Can not get to currency balance");let y=(T=i.success.find(w=>w.name==="redeem-fee"))==null?void 0:T.max;if(y){if(h=h.minus(y),h.isLessThan(0))a.push({id:"not-enough-funds",data:{type:"fees",currencyId:o.toNativeCurrencyInfo.currency.id,requiredAmount:y}});else if(P){let w=P[o.fromNativeCurrencyInfo.currency.id];w&&(h=h.minus(w.lockedAmount),h.isLessThanOrEqualTo(0)&&a.push({id:"not-enough-funds",data:{type:"swaps",currencyId:w.currencyId,swapIds:w.swapIds,lockedAmount:w.lockedAmount}}))}}}return{fromAddress:m,toAddress:d,maxOrderPreview:l}}async getMaxOrderPreview(e,t){let r=F.min(e,t.from.amount);return await this.atomexContext.managers.exchangeManager.getOrderPreview({type:t.type,from:t.from.currencyId,to:t.to.currencyId,amount:r,isFromAmount:!0})}async getUserInvolvedSwapsInfo(e,t,r){let o=e&&t?e!==t?[e,t].sort():[e]:e?[e]:t?[t]:void 0;if(!o)return;let i=this.getUserInvolvedSwapsCacheKey(o,r.fromCurrencyInfo.currency.id,r.toCurrencyInfo.currency.id),a=this.userInvolvedSwapsCache.get(i);if(a)return a;let c=await this.getInvolvedSwaps(o);return a=await this.getUserInvolvedSwapsInfoByActiveSwaps(c),this.userInvolvedSwapsCache.set(i,a),a}async getUserInvolvedSwapsInfoByActiveSwaps(e){let t={};for(let r of e){let o=this.getSwapCurrencyInfos(r.from.currencyId,r.to.currencyId),i=this.getOrCreateUserInvolvedSwapsCurrencyInfo(t,r.from.currencyId);i.swaps.push(r),i.swapIds.push(r.id),i.lockedAmount=i.lockedAmount.plus(r.from.amount);let a=await this.calculateSwapPreviewFees(o,{redeemEnabled:!r.counterParty.requisites.rewardForRedeem.isZero(),refundEnabled:!0}),c=_.calculateMaxTotalFee(a,o.fromNativeCurrencyInfo.currency.id),m=o.fromNativeCurrencyInfo.currency.id!==o.toNativeCurrencyInfo.currency.id?_.calculateMaxTotalFee(a,o.toCurrencyInfo.currency.id):void 0;if(o.isFromCurrencyNative)i.lockedAmount=i.lockedAmount.plus(c);else{let d=this.getOrCreateUserInvolvedSwapsCurrencyInfo(t,o.fromNativeCurrencyInfo.currency.id);d.swaps.push(r),d.swapIds.push(r.id),d.lockedAmount=d.lockedAmount.plus(c)}if(m){let d=this.getOrCreateUserInvolvedSwapsCurrencyInfo(t,o.toCurrencyInfo.currency.id);d.swaps.push(r),d.swapIds.push(r.id),d.lockedAmount=d.lockedAmount.plus(m)}}return t}getOrCreateUserInvolvedSwapsCurrencyInfo(e,t){return e[t]||(e[t]={currencyId:t,swaps:[],swapIds:[],lockedAmount:new F(0)}),e[t]}async getInvolvedSwaps(e){let t=await this.atomexContext.managers.swapManager.getSwaps(e),r=Date.now();return t.filter(i=>{if(!((i.user.status==="Created"||i.user.status==="Involved")&&(i.counterParty.status==="Created"||i.counterParty.status==="Involved"||i.counterParty.status==="PartiallyInitiated"||i.counterParty.status==="Initiated")))return!1;let a=i.timeStamp.getTime();return a+i.user.requisites.lockTime*1e3>r&&(i.counterParty.requisites.lockTime===0||a+i.counterParty.requisites.lockTime*1e3>r)})}async calculateSwapPreviewFees(e,t){let r=this.getSwapPreviewFeesCacheKey(e.fromCurrencyInfo,e.toCurrencyInfo,t),o=this.swapPreviewFeesCache.get(r);if(o)return o;let i=e.fromCurrencyInfo.atomexProtocol,a=e.toCurrencyInfo.atomexProtocol,c=await a.getRedeemFees({}),[m,d,l,p,v]=await Promise.all([i.getInitiateFees({}),t.redeemEnabled?a.getRedeemReward(c):c,t.refundEnabled?void 0:i.getRefundFees({}),a.getInitiateFees({}),i.getRedeemFees({})]),P={name:"payment-fee",currencyId:e.fromNativeCurrencyInfo.currency.id,estimated:m.estimated,max:m.max},T=await this.calculateMakerFees(e.fromCurrencyInfo.currency,e.fromNativeCurrencyInfo.currency,e.toNativeCurrencyInfo.currency,p,v),h=[P,T,{name:t.redeemEnabled?"redeem-reward":"redeem-fee",currencyId:t.redeemEnabled?e.toCurrencyInfo.currency.id:e.toNativeCurrencyInfo.currency.id,estimated:d.estimated,max:d.max}],y=[P,T];l&&y.push({name:"refund-fee",currencyId:e.fromNativeCurrencyInfo.currency.id,estimated:l.estimated,max:l.max});let w={success:h,refund:y};return this.swapPreviewFeesCache.set(r,w),w}async calculateMakerFees(e,t,r,o,i){let[a,c]=await Promise.all([e!==r?this.convertFeesFromNativeCurrencyToCustom(o,r,e):o,e!==t?this.convertFeesFromNativeCurrencyToCustom(i,t,e):i]);return{name:"maker-fee",currencyId:e.id,estimated:a.estimated.plus(c.estimated),max:a.max.plus(c.max)}}async convertFeesFromNativeCurrencyToCustom(e,t,r){let o=await this.atomexContext.managers.priceManager.getPrice({baseCurrency:t,quoteCurrency:r,provider:"atomex"});if(!o)throw new Error(`It's no possible to convert fees from "${t.id}" to "${r.id}" currency`);let[i,a]=b.convertFromAndToCurrenciesToSymbolAndSide(this.atomexContext.providers.exchangeSymbolsProvider.getSymbolsMap(),t.id,r.id),c=i.baseCurrency===r.id?i.decimals.baseCurrency:i.decimals.quoteCurrency,m=k.toFixedBigNumber(e.estimated.multipliedBy(o),c,F.ROUND_CEIL),d=k.toFixedBigNumber(e.max.multipliedBy(o),c,F.ROUND_CEIL);return{estimated:m,max:d}}getSwapPreviewFeesCacheKey(e,t,r){return`${e.currency.id}_${t.currency.id}_${r.redeemEnabled}_${r.refundEnabled}`}getUserInvolvedSwapsCacheKey(e,t,r){let o=t<r?t:r,i=o===t?r:t;return`${e.join("_")}_${o}_${i}`}static isNormalizedSwapPreviewParameters(e){return B.isNormalizedOrderPreviewParameters(e)}static normalizeSwapPreviewParameters(e,t,r){let o=B.normalizeOrderPreviewParameters(e,t);return{type:e.type,amount:e.amount,watchTower:e.watchTower===void 0||e.watchTower===null?r:{redeemEnabled:typeof e.watchTower.redeemEnabled=="boolean"?e.watchTower.redeemEnabled:r.redeemEnabled,refundEnabled:typeof e.watchTower.refundEnabled=="boolean"?e.watchTower.refundEnabled:r.refundEnabled},from:o.from,to:o.to,isFromAmount:o.isFromAmount,exchangeSymbol:o.exchangeSymbol,side:o.side,isBaseCurrencyAmount:o.isBaseCurrencyAmount}}static calculateMaxTotalFee(e,t){let r=this.calculateTotalFee(e.success,t),o=this.calculateTotalFee(e.refund,t);return F.max(r,o)}static calculateTotalFee(e,t){return e.reduce((r,o)=>o.currencyId===t&&o.name.endsWith("fee")?r.plus(o.max):r,new F(0))}};var Pe=class{constructor(e){this.options=e;s(this,"authorization");s(this,"exchangeManager");s(this,"balanceManager");s(this,"priceManager");s(this,"swapManager");s(this,"wallets");s(this,"atomexContext");s(this,"swapPreviewManager");s(this,"_isStarted",!1);if(this.atomexContext=e.atomexContext,this.swapPreviewManager=new _(e.atomexContext),this.wallets=e.managers.walletsManager,this.authorization=e.managers.authorizationManager,this.exchangeManager=e.managers.exchangeManager,this.swapManager=e.managers.swapManager,this.balanceManager=e.managers.balanceManager,this.priceManager=e.managers.priceManager,e.blockchains)for(let t of Object.keys(e.blockchains))this.addBlockchain(r=>[t,e.blockchains[t]])}get atomexNetwork(){return this.atomexContext.atomexNetwork}get isStarted(){return this._isStarted}async start(){this.isStarted||(await this.authorization.start(),await this.exchangeManager.start(),await this.swapManager.start(),this._isStarted=!0)}stop(){!this.isStarted||(this.authorization.stop(),this.exchangeManager.stop(),this.swapManager.stop(),this.balanceManager.dispose(),this.swapPreviewManager.dispose(),this._isStarted=!1)}addBlockchain(e){let[t,r]=e(this.atomexContext);this.atomexContext.providers.blockchainProvider.addBlockchain(t,r)}getCurrency(e){return this.atomexContext.providers.currenciesProvider.getCurrency(e)}getSwapPreview(e){return this.swapPreviewManager.getSwapPreview(e)}async swap(e,t=15){var C;if(typeof e=="number")throw new Error("Swap tracking is not implemented yet");let r=e.swapPreview;if(r.errors.length)throw new Error("Swap preview has errors");let o=r.from.address;if(!o)throw new Error(`Swap preview doesn't have the "from" address`);let i=r.to.address;if(!i)throw new Error(`Swap preview doesn't have the "to" address`);let[a,c]=b.getBaseQuoteCurrenciesBySymbol(r.symbol),m=this.atomexContext.providers.blockchainProvider.getCurrencyInfo(a);if(!m)throw new Error(`The "${a}" currency (base) is unknown`);let d=this.atomexContext.providers.blockchainProvider.getCurrencyInfo(c);if(!d)throw new Error(`The "${c}" currency (quote) is unknown`);if(m.atomexProtocol.type!=="multi-chain")throw new Error(`Unknown type (${m.atomexProtocol.type}) of the Atomex protocol (base)`);if(d.atomexProtocol.type!=="multi-chain")throw new Error(`Unknown type (${d.atomexProtocol.type}) of the Atomex protocol (quote)`);let l=m.atomexProtocol,p=d.atomexProtocol,v=a===r.from.currencyId?"from":"to",P=(C=r.fees.success.find(f=>f.name=="redeem-reward"))==null?void 0:C.estimated,T={orderBody:{type:r.type,symbol:r.symbol,side:r.side,amount:r[v].actual.amount,price:r[v].actual.price},requisites:{secretHash:null,receivingAddress:i,refundAddress:e.refundAddress||null,rewardForRedeem:P||new Ft(0),lockTime:18e3,baseCurrencyContract:l.swapContractAddress,quoteCurrencyContract:p.swapContractAddress}},h=await this.exchangeManager.addOrder(o,T),y=await this.exchangeManager.getOrder(o,h);if(!y)throw new Error(`The ${h} order not found`);if(y.status!=="Filled")throw new Error(`The ${h} order is not filled`);let w=await Promise.all(y.swapIds.map(f=>this.swapManager.getSwap(f,o)));if(!w.length)throw new Error("Swaps not found");if(w.some(f=>!f))throw new Error("Swap not found");return this.swapPreviewManager.clearCache(),w.length===1?w[0]:w}async convertCurrency(e,t,r){let o=await this.priceManager.getAveragePrice({baseCurrency:t,quoteCurrency:r});if(!o)return;let a=(Ft.isBigNumber(e)?e:new Ft(e)).multipliedBy(o),c=this.getCurrency(r);return c?H(a,c.decimals):a}};var A=class extends Error{constructor(t){super(A.getMessage(t));s(this,"name");s(this,"componentName");this.componentName=t,this.name=this.constructor.name}static getMessage(t){return`Atomex "${t}" component has not resolved yet`}};var qt=class{constructor(e){this.atomexNetwork=e;s(this,"id");s(this,"managers");s(this,"services");s(this,"providers");this.id=qt.idCounter++,this.managers=new _t(this),this.services=new Wt(this),this.providers=new Dt(this)}},ke=qt;s(ke,"idCounter",0);var _t=class{constructor(e){this.context=e;s(this,"_walletsManager");s(this,"_authorizationManager");s(this,"_exchangeManager");s(this,"_swapManager");s(this,"_priceManager");s(this,"_balanceManager")}get walletsManager(){if(!this._walletsManager)throw new A("managers.walletsManager");return this._walletsManager}set walletsManager(e){this._walletsManager=e}get authorizationManager(){if(!this._authorizationManager)throw new A("managers.authorizationManager");return this._authorizationManager}set authorizationManager(e){this._authorizationManager=e}get exchangeManager(){if(!this._exchangeManager)throw new A("managers.exchangeManager");return this._exchangeManager}set exchangeManager(e){this._exchangeManager=e}get swapManager(){if(!this._swapManager)throw new A("managers.swapManager");return this._swapManager}set swapManager(e){this._swapManager=e}get priceManager(){if(!this._priceManager)throw new A("managers.priceManager");return this._priceManager}set priceManager(e){this._priceManager=e}get balanceManager(){if(!this._balanceManager)throw new A("managers.balanceManager");return this._balanceManager}set balanceManager(e){this._balanceManager=e}},Wt=class{constructor(e){this.context=e;s(this,"_exchangeService");s(this,"_swapService")}get exchangeService(){if(!this._exchangeService)throw new A("services.exchangeService");return this._exchangeService}set exchangeService(e){this._exchangeService=e}get swapService(){if(!this._swapService)throw new A("services.swapService");return this._swapService}set swapService(e){this._swapService=e}},Dt=class{constructor(e){this.context=e;s(this,"_blockchainProvider");s(this,"_currenciesProvider");s(this,"_exchangeSymbolsProvider");s(this,"_orderBookProvider")}get blockchainProvider(){if(!this._blockchainProvider)throw new A("providers.blockchainProvider");return this._blockchainProvider}set blockchainProvider(e){this._blockchainProvider=e}get currenciesProvider(){if(!this._currenciesProvider)throw new A("providers.currenciesProvider");return this._currenciesProvider}set currenciesProvider(e){this._currenciesProvider=e}get exchangeSymbolsProvider(){if(!this._exchangeSymbolsProvider)throw new A("providers.exchangeSymbolsProvider");return this._exchangeSymbolsProvider}set exchangeSymbolsProvider(e){this._exchangeSymbolsProvider=e}get orderBookProvider(){if(!this._orderBookProvider)throw new A("providers.orderBookProvider");return this._orderBookProvider}set orderBookProvider(e){this._orderBookProvider=e}};var Ut=class{constructor(e){this.blockchainProvider=e;s(this,"cache");this.cache=new M({absoluteExpirationMs:Ut.cacheExpirationTime})}async getBalance(e,t,r=3){var i;let o=this.getCacheKey(e,t);if((r&1)===1){let a=this.cache.get(o);if(a)return a}if((r&2)===2){let a=(i=this.blockchainProvider.getCurrencyInfo(t.id))==null?void 0:i.balanceProvider;if(!a)throw new Error(`Balance provider not found for currency: ${t.id}`);let c=await a.getBalance(e);return this.cache.set(o,c),c}}dispose(){return this.cache.dispose()}getCacheKey(e,t){return`${e}_${t.id}`}},Ae=Ut;s(Ae,"cacheExpirationTime",1e3*60*1);var Te=class{constructor(e){this.atomexNetwork=e;s(this,"wallets",new Set)}addWallet(e){return R.ensureNetworksAreSame(this,e),this.wallets.add(e),Promise.resolve(e)}async removeWallet(e){let t=this.wallets.delete(e);return Promise.resolve(t)}async getWallet(e,t,r){if(!this.wallets.size||!e&&!t&&!r)return;let o=[];for(let a of this.wallets){if(r&&a.id!==r)continue;let c=e?a.getAddress():void 0,m=t?a.getBlockchain():void 0;if((!e||e===c)&&(!t||t==m))return a;o.push(Promise.all([c,m]).then(([d,l])=>[a,d,l]))}let i=await Promise.allSettled(o);for(let a of i){if(a.status!=="fulfilled")continue;let[c,m,d]=a.value;if((!e||e===m)&&(!t||t==d))return c}}};var E={};O(E,{getRedeemRewardInNativeCurrency:()=>ur,getRedeemRewardInToken:()=>uo});import pr from"bignumber.js";var ur=async(n,e,t,r)=>{let o=typeof n=="string"?r.getCurrency(n):n;if(!o)throw new Error(`Currency info not found for ${n}`);let i=await t.getAveragePrice({baseCurrency:o,quoteCurrency:"USD"});if(!i)throw new Error(`Price for ${n} in USD not found`);let a=30,c=.15,m=.05,d=e.estimated.multipliedBy(i),l=a/Math.log((1-c)/m),p=(1-c)/Math.exp(d.toNumber()/l)+c,v=H(e.estimated.multipliedBy(1+p),Math.min(o.decimals,9),pr.ROUND_FLOOR);return{estimated:v,max:v}},uo=async(n,e,t,r)=>{var d;let o=typeof n=="string"?r.getCurrency(n):n;if(!o)throw new Error(`Currency info not found for ${n}`);let i=(d=r.getNativeCurrencyInfo(o.blockchain))==null?void 0:d.currency;if(!i)throw new Error(`Native currency not found fir ${o.blockchain}`);let a=await t.getAveragePrice({baseCurrency:i,quoteCurrency:n});if(!a)throw new Error(`Price for ${i.id} in ${o.id} not found`);let c=await ur(i.id,e,t,r),m=H(c.estimated.multipliedBy(a),Math.min(o.decimals,9),pr.ROUND_FLOOR);return{estimated:m,max:m}};var Le=class{constructor(e,t){this.currency=e;this.getBalanceImplementation=t}getBalance(e){return this.getBalanceImplementation(e)}};var $e=class{constructor(){s(this,"currencyInfoMap",new Map);s(this,"networkOptionsMap",new Map);s(this,"blockchainToolkitProviders",new Set)}addBlockchain(e,t){var r,o;if(this.networkOptionsMap.has(e))throw new Error("There is already blockchain added with the same key");this.networkOptionsMap.set(e,t),this.blockchainToolkitProviders.add(t.blockchainToolkitProvider);for(let i of t.currencies){if(this.currencyInfoMap.has(i.id))throw new Error("There is already currency added with the same key");let a=t.currencyOptions[i.id],c=a==null?void 0:a.atomexProtocol;if(!c)throw new Error(`Atomex protocol is not defined for the "${i.id}" currency`);let m={currency:i,atomexProtocol:c,blockchainToolkitProvider:t.blockchainToolkitProvider,balanceProvider:(r=a==null?void 0:a.currencyBalanceProvider)!=null?r:this.createControlledBalancesProvider(i,t.balancesProvider),swapTransactionsProvider:(o=a==null?void 0:a.swapTransactionsProvider)!=null?o:t.swapTransactionsProvider};this.currencyInfoMap.set(i.id,m)}}getNetworkOptions(e){return this.networkOptionsMap.get(e)}async getReadonlyToolkit(e,t){let r=[];for(let i of this.blockchainToolkitProviders)i.toolkitId===e&&r.push(i.getReadonlyToolkit(t));let o=await Promise.all(r);for(let i of o)if(i)return i;return Promise.resolve(void 0)}getCurrency(e){var t;return(t=this.getCurrencyInfo(e))==null?void 0:t.currency}getNativeCurrencyInfo(e){for(let t of this.currencyInfoMap)if(t[1].currency.type==="native"&&t[1].currency.blockchain===e)return t[1]}getCurrencyInfo(e){return this.currencyInfoMap.get(e)}createControlledBalancesProvider(e,t){return new Le(e,r=>t.getBalance(r,e))}};import yr from"bignumber.js";var W={};O(W,{convertFromWei:()=>xo,getGasPriceInWei:()=>hr,getMaxFeePerGas:()=>fo});import ht from"bignumber.js";var go=new ht(25e8),hr=async n=>{let e=await n.eth.getGasPrice();return new ht(e)},fo=async(n,e=go)=>{let t=await n.eth.getBlock("latest");return t.baseFeePerGas?new ht(t.baseFeePerGas).multipliedBy(2).plus(e):hr(n)},xo=(n,e,t)=>{let r=typeof e=="string"?e:e.toString(10),o=n.utils.fromWei(r,t);return new ht(o)};var Ke=class{constructor(e,t,r,o,i,a){this.blockchain=e;this.atomexNetwork=t;this.atomexProtocolOptions=r;this.atomexBlockchainProvider=o;this.walletsManager=i;this.priceManager=a}get currencyId(){return this.atomexProtocolOptions.currencyId}get swapContractAddress(){return this.atomexProtocolOptions.swapContractAddress}async getInitiateFees(e){var p;let t=await this.getReadonlyWeb3(),r=await W.getMaxFeePerGas(t),o=this.atomexProtocolOptions.initiateOperation.gasLimit,i=(p=e.rewardForRedeem)==null?void 0:p.isGreaterThan(0),a=new yr(i?o.withReward:o.withoutReward),c=r.multipliedBy(a),m=W.convertFromWei(t,c,"ether"),d=m.multipliedBy(Ke.defaultMaxNetworkFeeMultiplier),l={estimated:m,max:d};return Promise.resolve(l)}async getRedeemFees(e){let t=await this.getReadonlyWeb3(),r=await W.getMaxFeePerGas(t),o=this.atomexProtocolOptions.redeemOperation.gasLimit,i=r.multipliedBy(o).multipliedBy(Ke.defaultMaxNetworkFeeMultiplier),a=W.convertFromWei(t,i,"ether"),c={estimated:a,max:a};return Promise.resolve(c)}async getRefundFees(e){let t=await this.getReadonlyWeb3(),r=await W.getMaxFeePerGas(t),o=this.atomexProtocolOptions.refundOperation.gasLimit,i=r.multipliedBy(o).multipliedBy(Ke.defaultMaxNetworkFeeMultiplier),a=W.convertFromWei(t,i,"ether"),c={estimated:a,max:a};return Promise.resolve(c)}async getReadonlyWeb3(){let e=await this.atomexBlockchainProvider.getReadonlyToolkit("web3",this.blockchain);if(!e)throw new Error("Web3 toolkit not found");return e}async getWallet(e){let t=await this.walletsManager.getWallet(e,this.blockchain,"web3");if(!t)throw new Error(`${this.blockchain} Web3 wallet not found`);return t}async getTransaction(e,t,r){let o=await e.eth.getBlockNumber();return{type:t,currencyId:this.currencyId,blockId:r.blockNumber,id:r.transactionHash,status:String(r.status),confirmations:Math.max(o-r.blockNumber,0)}}},D=Ke;s(D,"defaultMaxNetworkFeeMultiplier",new yr(1.2));import So from"web3";import{ec as wo}from"elliptic";var Lt=n=>n.blockchain==="ethereum";var $t=null,bo=()=>($t||($t=new wo("secp256k1")),$t),vo=n=>{let e=k.hexStringToUint8Array(n);if(e.length!==64&&e.length!==65)throw new Error(`Invalid signature: ${n}`);let t=e.length===64?27+(e[32]>>7):e[64];return(t===0||t===1)&&(t+=27),{r:ut(e.slice(0,32)),s:ut(e.slice(32,64)),v:t,recoveryParameter:1-t%2}},gr=(n,e)=>{let t=vo(n),r=K.from(e.startsWith("0x")?e.substring(2):e,"hex"),o=bo().recoverPubKey(r,{r:t.r,s:t.s},t.recoveryParameter);return"0x"+o.encode("hex",!1)};var yt=class{constructor(e,t){this.atomexNetwork=e;this.provider=t;s(this,"id","web3");s(this,"toolkit");this.toolkit=new So(t)}async getBlockchain(){switch(await this.toolkit.eth.getChainId()){case 1:case 5:return"ethereum";case 56:case 97:return"binance"}return""}async getAddress(){let t=(await this.toolkit.eth.getAccounts())[0];if(!t)throw new Error("Address is unavailable");return t}getPublicKey(){}async sign(e){let t=await this.getAddress(),r=await this.signInternal(e,t),o=gr(r,this.toolkit.eth.accounts.hashMessage(e));return{address:t,publicKeyBytes:o.startsWith("0x")?o.substring(2):o,signatureBytes:r.substring(r.startsWith("0x")?2:0,r.length-2),algorithm:yt.signingAlgorithm}}signInternal(e,t){return new Promise((r,o)=>this.toolkit.eth.personal.sign(e,t,"",(i,a)=>a?r(a):o(i)))}static async bind(e,t){let r=new yt(e.atomexNetwork,t);return await e.wallets.addWallet(r),r}},Ce=yt;s(Ce,"signingAlgorithm","Keccak256WithEcdsa:Geth2940");import Po from"web3";var ce=class{constructor(e,t){this.blockchain=e;this.rpcUrl=t;s(this,"toolkitId","web3");s(this,"toolkit")}getReadonlyToolkit(e){return e&&e!==this.blockchain?Promise.resolve(void 0):(this.toolkit||(this.toolkit=new Po(this.rpcUrl)),Promise.resolve(this.toolkit))}};import fr from"bignumber.js";var Kt=[{constant:!0,inputs:[],name:"name",outputs:[{name:"",type:"string"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"_spender",type:"address"},{name:"_value",type:"uint256"}],name:"approve",outputs:[{name:"",type:"bool"}],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[],name:"totalSupply",outputs:[{name:"",type:"uint256"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"_from",type:"address"},{name:"_to",type:"address"},{name:"_value",type:"uint256"}],name:"transferFrom",outputs:[{name:"",type:"bool"}],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[],name:"decimals",outputs:[{name:"",type:"uint8"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[{name:"_owner",type:"address"}],name:"balanceOf",outputs:[{name:"balance",type:"uint256"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[],name:"symbol",outputs:[{name:"",type:"string"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"_to",type:"address"},{name:"_value",type:"uint256"}],name:"transfer",outputs:[{name:"",type:"bool"}],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[{name:"_owner",type:"address"},{name:"_spender",type:"address"}],name:"allowance",outputs:[{name:"",type:"uint256"}],payable:!1,stateMutability:"view",type:"function"},{payable:!0,stateMutability:"payable",type:"fallback"},{anonymous:!1,inputs:[{indexed:!0,name:"owner",type:"address"},{indexed:!0,name:"spender",type:"address"},{indexed:!1,name:"value",type:"uint256"}],name:"Approval",type:"event"},{anonymous:!1,inputs:[{indexed:!0,name:"from",type:"address"},{indexed:!0,name:"to",type:"address"},{indexed:!1,name:"value",type:"uint256"}],name:"Transfer",type:"event"}];var Me=class{constructor(e){this.blockchainProvider=e}async getBalance(e,t){if(!Lt(t))throw new Error("Not ethereum blockchain currency provided");let r=await this.blockchainProvider.getReadonlyToolkit("web3");if(!r)throw new Error("Readonly web3 toolkit not found");switch(t.type){case"native":return await this.getNativeTokenBalance(e,t,r);case"erc-20":return await this.getTokenBalance(e,t,r)}}async getNativeTokenBalance(e,t,r){let o=await r.eth.getBalance(e);return re(new fr(o),t.decimals)}async getTokenBalance(e,t,r){let i=await new r.eth.Contract(Kt,t.contractAddress).methods.balanceOf(e).call();return re(new fr(i),t.decimals)}};var Q=class extends D{constructor(t,r,o,i,a){super("ethereum",t,r,o,i,a);this.atomexProtocolOptions=r;s(this,"type","multi-chain")}async initiate(t){let r=await this.getWallet(t.senderAddress),i=new r.toolkit.eth.Contract(this.atomexProtocolOptions.abi,this.swapContractAddress).methods.initiate("0x"+t.secretHash,t.receivingAddress,Math.round(t.refundTimestamp.getTime()/1e3),t.rewardForRedeem.toString(10)).encodeABI(),a=t.rewardForRedeem.isZero()?this.atomexProtocolOptions.initiateOperation.gasLimit.withoutReward:this.atomexProtocolOptions.initiateOperation.gasLimit.withReward,c=await r.toolkit.eth.sendTransaction({from:t.senderAddress,to:this.swapContractAddress,value:r.toolkit.utils.toWei(t.amount.toString(10),"ether"),gas:a,data:i});return this.getTransaction(r.toolkit,"Lock",c)}async redeem(t){let r=await this.getWallet(t.senderAddress),i=await new r.toolkit.eth.Contract(this.atomexProtocolOptions.abi,this.atomexProtocolOptions.swapContractAddress).methods.redeem(`0x${t.secretHash}`,`0x${t.secret}`).send({from:t.senderAddress,gas:this.atomexProtocolOptions.redeemOperation.gasLimit});return this.getTransaction(r.toolkit,"Redeem",i)}getRedeemReward(t){return E.getRedeemRewardInNativeCurrency(this.currencyId,t,this.priceManager,this.atomexBlockchainProvider)}async refund(t){let r=await this.getWallet(t.senderAddress),i=await new r.toolkit.eth.Contract(this.atomexProtocolOptions.abi,this.atomexProtocolOptions.swapContractAddress).methods.refund(`0x${t.secretHash}`).send({from:t.senderAddress,gas:this.atomexProtocolOptions.refundOperation.gasLimit});return this.getTransaction(r.toolkit,"Refund",i)}};var j=class extends D{constructor(t,r,o,i,a){super("ethereum",t,r,o,i,a);this.atomexProtocolOptions=r;s(this,"type","multi-chain-approvable")}approve(t){throw new Error("Method not implemented.")}initiate(t){throw new Error("Method not implemented.")}redeem(t){throw new Error("Method not implemented.")}getRedeemReward(t){return E.getRedeemRewardInToken(this.currencyId,t,this.priceManager,this.atomexBlockchainProvider)}refund(t){throw new Error("Method not implemented.")}};var Be=class{constructor(){s(this,"_isStarted",!1)}get isStarted(){return this._isStarted}async start(){this.isStarted||(this._isStarted=!0)}stop(){!this.isStarted||(this._isStarted=!1)}getSwapTransactions(e){throw new Error("Method not implemented.")}};var xr={id:"ETH",name:"Ethereum",symbol:"ETH",blockchain:"ethereum",decimals:18,type:"native"},He=[xr],Ge=[xr];var wr=[{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"Activated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{indexed:!1,internalType:"address",name:"_sender",type:"address"},{indexed:!1,internalType:"uint256",name:"_value",type:"uint256"}],name:"Added",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{indexed:!0,internalType:"address",name:"_participant",type:"address"},{indexed:!1,internalType:"address",name:"_initiator",type:"address"},{indexed:!1,internalType:"uint256",name:"_refundTimestamp",type:"uint256"},{indexed:!1,internalType:"uint256",name:"_countdown",type:"uint256"},{indexed:!1,internalType:"uint256",name:"_value",type:"uint256"},{indexed:!1,internalType:"uint256",name:"_payoff",type:"uint256"},{indexed:!1,internalType:"bool",name:"_active",type:"bool"}],name:"Initiated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{indexed:!1,internalType:"bytes32",name:"_secret",type:"bytes32"}],name:"Redeemed",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"Refunded",type:"event"},{constant:!0,inputs:[{internalType:"bytes32",name:"",type:"bytes32"}],name:"swaps",outputs:[{internalType:"bytes32",name:"hashedSecret",type:"bytes32"},{internalType:"address payable",name:"initiator",type:"address"},{internalType:"address payable",name:"participant",type:"address"},{internalType:"uint256",name:"refundTimestamp",type:"uint256"},{internalType:"uint256",name:"countdown",type:"uint256"},{internalType:"uint256",name:"value",type:"uint256"},{internalType:"uint256",name:"payoff",type:"uint256"},{internalType:"bool",name:"active",type:"bool"},{internalType:"enum Atomex.State",name:"state",type:"uint8"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{internalType:"address payable",name:"_participant",type:"address"},{internalType:"uint256",name:"_refundTimestamp",type:"uint256"},{internalType:"uint256",name:"_payoff",type:"uint256"}],name:"initiate",outputs:[],payable:!0,stateMutability:"payable",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"add",outputs:[],payable:!0,stateMutability:"payable",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"activate",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{internalType:"bytes32",name:"_secret",type:"bytes32"}],name:"redeem",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"refund",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"}];var ko={atomexProtocolVersion:1,currencyId:"ETH",swapContractAddress:"0xe9c251cbb4881f9e056e40135e7d3ea9a7d037df",swapContractBlockId:"8168569",initiateOperation:{gasLimit:{withoutReward:2e5,withReward:21e4}},redeemOperation:{gasLimit:14e4},refundOperation:{gasLimit:9e4},defaultGasPriceInGwei:90,maxGasPriceInGwei:650,abi:wr},me={ETH:ko};var Ao=S(x({},me.ETH),{swapContractAddress:"0x512fe6B803bA327DCeFBF2Cec7De333f761B0f2b",swapContractBlockId:"6954501"}),Qe={ETH:Ao};var To=(n,e,t)=>{switch(e.type){case"native":return new Q(n.atomexNetwork,t,n.providers.blockchainProvider,n.managers.walletsManager,n.managers.priceManager);case"erc-20":return new j(n.atomexNetwork,t,n.providers.blockchainProvider,n.managers.walletsManager,n.managers.priceManager);default:throw new Error(`Unknown Ethereum currency: ${e.id}`)}},br=(n,e,t)=>{let r={},o=e.reduce((i,a)=>(i[a.id]=a,i),{});for(let i of Object.values(t)){let a=o[i.currencyId];if(!a)throw new Error(`The ${i.currencyId} currency not found`);r[a.id]={atomexProtocol:To(n,a,i)}}return r},gt=n=>{let e="ethereum",t="https://mainnet.infura.io/v3/df01d4ef450640a2a48d9af4c2078eaf",r="https://goerli.infura.io/v3/df01d4ef450640a2a48d9af4c2078eaf",o=new Me(n.providers.blockchainProvider),i=new Be;return n.atomexNetwork==="mainnet"?{rpcUrl:t,currencies:He,currencyOptions:br(n,He,me),blockchainToolkitProvider:new ce(e,t),balancesProvider:o,swapTransactionsProvider:i}:{rpcUrl:r,currencies:Ge,currencyOptions:br(n,Ge,Qe),blockchainToolkitProvider:new ce(e,r),balancesProvider:o,swapTransactionsProvider:i}};var ft=class{constructor(e){this.swapService=e;s(this,"events",{swapUpdated:new g});s(this,"_isStarted",!1);s(this,"handleSwapServiceSwapUpdated",e=>{this.events.swapUpdated.emit(e)})}get isStarted(){return this._isStarted}async start(){this.isStarted||(this.attachEvents(),await this.swapService.start(),this._isStarted=!0)}stop(){!this.isStarted||(this.detachEvents(),this.swapService.stop(),this._isStarted=!1)}getSwap(e,t,r=2){return this.swapService.getSwap(e,t)}getSwaps(e,t,r=2){return this.swapService.getSwaps(e,t)}attachEvents(){this.swapService.events.swapUpdated.addListener(this.handleSwapServiceSwapUpdated)}detachEvents(){this.swapService.events.swapUpdated.removeListener(this.handleSwapServiceSwapUpdated)}};import{SigningType as qo}from"@airgap/beacon-sdk";import{TezosToolkit as Uo}from"@taquito/taquito";import{b58cdecode as Fo,prefix as _o,validatePkAndExtractPrefix as Wo}from"@taquito/utils";import Do from"bignumber.js";var Ht=n=>n.blockchain==="tezos",Gt=n=>n.blockchain==="tezos"&&n.type==="fa1.2",Sr=n=>n.blockchain==="tezos"&&n.type==="fa2";var I={};O(I,{decodeSignature:()=>je,getRawMichelineSigningData:()=>Oo,getRawSigningData:()=>Eo,getTezosSigningAlgorithm:()=>zo,getWalletMichelineSigningData:()=>Io});import{b58cdecode as Co,prefix as Mo,Prefix as Ee}from"@taquito/utils";var Bo="54657a6f73205369676e6564204d6573736167653a20",Pr=(n,e)=>{let t=k.stringToHexString(n),r=e?e+t:t,o=De.padStart((r.length/2).toString(16),8,"0");return"0501"+o+r},Eo=n=>k.stringToHexString(n),Oo=n=>Pr(n),Io=n=>Pr(n,Bo),zo=n=>{let e=n.substring(0,n.startsWith("tz")?3:4);switch(e){case Ee.TZ1:case Ee.EDPK:return"Ed25519:Blake2b";case Ee.TZ2:case Ee.SPPK:return"Blake2bWithEcdsa:Secp256k1";case Ee.TZ3:case Ee.P2PK:return"Blake2bWithEcdsa:Secp256r1";default:throw new Error(`Unexpected address/public key prefix: ${e} (${n})`)}},je=n=>{let e=n.startsWith("sig")?n.substring(0,3):n.substring(0,5),t=Co(n,Mo[e]);return Buffer.from(t).toString("hex")};var Ze={};O(Ze,{wrapContractCallsWithApprove:()=>No});var No=n=>{let e=n.toolkit.wallet.batch().withContractCall(n.tokenContract.methods.approve(n.approvedAddress,n.approvedAmount));return n.contractCalls.forEach(t=>e.withContractCall(t)),e};var Ve={};O(Ve,{wrapContractCallsWithApprove:()=>Ro});var Ro=n=>{let e=n.toolkit.wallet.batch().withContractCall(n.tokenContract.methods.update_operators([{add_operator:{owner:n.ownerAddress,operator:n.approvedAddress,token_id:n.tokenId}}]));return n.contractCalls.forEach(t=>e.withContractCall(t)),e.withContractCall(n.tokenContract.methods.update_operators([{remove_operator:{owner:n.ownerAddress,operator:n.approvedAddress,token_id:n.tokenId}}])),e};var Oe=new Do(1e6),Ie=n=>{let e=Wo(n),t=Fo(n,_o[e]);return K.from(t).toString("hex")};var xt=class{constructor(e,t,r){this.atomexNetwork=e;this.beaconWallet=t;s(this,"id","taquito");s(this,"toolkit");this.toolkit=new Uo(r),this.toolkit.setWalletProvider(t)}getBlockchain(){return"tezos"}getAddress(){return this.beaconWallet.getPKH()}async getPublicKey(){var e;return(e=await this.beaconWallet.client.getActiveAccount())==null?void 0:e.publicKey}async sign(e){let[t,r,o]=await Promise.all([this.getAddress(),this.getPublicKey(),this.beaconWallet.client.requestSignPayload({payload:I.getWalletMichelineSigningData(e),signingType:qo.MICHELINE})]);if(!r)throw new Error("BeaconWallet: public key is unavailable");let i=I.getTezosSigningAlgorithm(r),a=Ie(r),c=je(o.signature);return{address:t,algorithm:i,publicKeyBytes:a,signatureBytes:c,signingDataType:"tezos/wallet-micheline"}}};import{InMemorySigner as Lo}from"@taquito/signer";import{TezosToolkit as $o}from"@taquito/taquito";var wt=class{constructor(e,t,r){this.atomexNetwork=e;s(this,"id","taquito");s(this,"toolkit");s(this,"internalInMemorySigner");this.internalInMemorySigner=new Lo(t),this.toolkit=new $o(r),this.toolkit.setSignerProvider(this.internalInMemorySigner)}getBlockchain(){return"tezos"}getAddress(){return this.internalInMemorySigner.publicKeyHash()}getPublicKey(){return this.internalInMemorySigner.publicKey()}async sign(e){let t=I.getRawSigningData(e),[r,o,i]=await Promise.all([this.getAddress(),this.getPublicKey(),this.internalInMemorySigner.sign(t)]),a=Ie(o),c=i.sbytes.substring(i.bytes.length),m=I.getTezosSigningAlgorithm(o);return{address:r,algorithm:m,publicKeyBytes:a,signatureBytes:c}}};import{TezosToolkit as Ko}from"@taquito/taquito";var bt=class{constructor(e,t,r){this.atomexNetwork=e;this.templeWallet=t;s(this,"id","taquito");s(this,"blockchain","tezos");s(this,"toolkit");this.toolkit=new Ko(r),this.toolkit.setWalletProvider(t)}getBlockchain(){return"tezos"}getAddress(){return this.templeWallet.getPKH()}getPublicKey(){var e;return(e=this.templeWallet.permission)==null?void 0:e.publicKey}async sign(e){let[t,r,o]=await Promise.all([this.getAddress(),this.getPublicKey(),this.templeWallet.sign(I.getWalletMichelineSigningData(e))]);if(!r)throw new Error("TempleWallet: public key is unavailable");let i=I.getTezosSigningAlgorithm(r),a=Ie(r),c=je(o);return{address:t,algorithm:i,publicKeyBytes:a,signatureBytes:c,signingDataType:"tezos/wallet-micheline"}}};var de=class{constructor(e,t,r){this.atomexNetwork=e;this.walletOrSecretKey=t;this.rpcUrl=r;s(this,"internalWallet");this.internalWallet=this.createInternalWallet(t)}get id(){return this.internalWallet.id}get toolkit(){return this.internalWallet.toolkit}getAddress(){return this.internalWallet.getAddress()}getPublicKey(){return this.internalWallet.getPublicKey()}getBlockchain(){return this.internalWallet.getBlockchain()}sign(e){return this.internalWallet.sign(e)}createInternalWallet(e){var t;if(typeof e=="string")return new wt(this.atomexNetwork,e,this.rpcUrl);if(((t=e.client)==null?void 0:t.name)!==void 0)return new xt(this.atomexNetwork,e,this.rpcUrl);if(e.permission!==void 0&&e.connected!==void 0)return new bt(this.atomexNetwork,e,this.rpcUrl);throw new Error("Unknown Tezos wallet")}static async bind(e,t){var a;let r="tezos",o=(a=e.atomexContext.providers.blockchainProvider.getNetworkOptions(r))==null?void 0:a.rpcUrl;if(!o)throw new Error(`There is not rpc url for ${r} network`);let i=new de(e.atomexNetwork,t,o);return await e.wallets.addWallet(i),i}};import Qt from"bignumber.js";var Z=class{constructor(e,t,r,o,i,a){this.blockchain=e;this.atomexNetwork=t;this.atomexProtocolOptions=r;this.atomexBlockchainProvider=o;this.walletsManager=i;this.priceManager=a;s(this,"type","multi-chain")}get currencyId(){return this.atomexProtocolOptions.currencyId}get swapContractAddress(){return this.atomexProtocolOptions.swapContractAddress}getInitiateFees(e){let t=new Qt(this.atomexProtocolOptions.initiateOperation.fee).div(Oe),r={estimated:t,max:t};return Promise.resolve(r)}async redeem(e){let o=await(await(await this.getWallet(e.senderAddress)).toolkit.wallet.at(this.swapContractAddress)).methodsObject.redeem(e.secret).send();return this.getTransaction("Redeem",o)}getRedeemFees(e){let t=new Qt(this.atomexProtocolOptions.redeemOperation.fee).div(Oe),r={estimated:t,max:t};return Promise.resolve(r)}async refund(e){let o=await(await(await this.getWallet(e.senderAddress)).toolkit.wallet.at(this.swapContractAddress)).methodsObject.refund(e.secret).send();return this.getTransaction("Refund",o)}getRefundFees(e){let t=new Qt(this.atomexProtocolOptions.refundOperation.fee).div(Oe),r={estimated:t,max:t};return Promise.resolve(r)}async getReadonlyTezosToolkit(){let e=await this.atomexBlockchainProvider.getReadonlyToolkit("taquito",this.blockchain);if(!e)throw new Error("Tezos toolkit not found");return e}async getWallet(e){let t=await this.walletsManager.getWallet(e,this.blockchain,"taquito");if(!t)throw new Error(`${this.blockchain} Taquito wallet not found`);return t}async getTransaction(e,t){let r=await t.status(),o=await t.confirmation();return{id:t.opHash,blockId:o.block.header.level,confirmations:o.currentConfirmation,currencyId:this.currencyId,status:r,type:e}}formatDate(e){return e.toISOString().slice(0,-5)+"Z"}};var V=class extends Z{constructor(t,r,o,i,a){super("tezos",t,r,o,i,a);this.atomexProtocolOptions=r}async initiate(t){let i=await(await(await this.getWallet(t.senderAddress)).toolkit.wallet.at(this.swapContractAddress)).methodsObject.initiate({settings:{hashed_secret:t.secretHash,refund_time:this.formatDate(t.refundTimestamp),payoff:t.rewardForRedeem.multipliedBy(Oe)},participant:t.receivingAddress}).send({amount:t.amount.toNumber()});return this.getTransaction("Lock",i)}getRedeemReward(t){return E.getRedeemRewardInNativeCurrency(this.currencyId,t,this.priceManager,this.atomexBlockchainProvider)}};import Ho from"bignumber.js";var X=class extends Z{constructor(t,r,o,i,a){super("tezos",t,r,o,i,a);this.atomexProtocolOptions=r}async initiate(t){let r=this.atomexBlockchainProvider.getCurrency(this.currencyId);if(!r)throw new Error(`Currency not found for id: ${this.currencyId}`);if(!Gt(r))throw new Error(`Currency with id ${this.currencyId} is not fa1.2`);let o=new Ho(10).pow(r.decimals),i=t.amount.multipliedBy(o),a=await this.getWallet(t.senderAddress),[c,m]=await Promise.all([a.toolkit.wallet.at(this.swapContractAddress),a.toolkit.wallet.at(r.contractAddress)]),d=await Ze.wrapContractCallsWithApprove({toolkit:a.toolkit,tokenContract:m,approvedAmount:i,approvedAddress:c.address,contractCalls:[c.methodsObject.initiate({totalAmount:i,tokenAddress:r.contractAddress,refundTime:this.formatDate(t.refundTimestamp),payoffAmount:t.rewardForRedeem.multipliedBy(o),hashedSecret:t.secretHash,participant:t.receivingAddress})]}).send();return this.getTransaction("Lock",d)}getRedeemReward(t){return E.getRedeemRewardInToken(this.currencyId,t,this.priceManager,this.atomexBlockchainProvider)}};import Go from"bignumber.js";var J=class extends Z{constructor(t,r,o,i,a){super("tezos",t,r,o,i,a);this.atomexProtocolOptions=r}async initiate(t){let r=this.atomexBlockchainProvider.getCurrency(this.currencyId);if(!r)throw new Error(`Currency not found for id: ${this.currencyId}`);if(!Sr(r))throw new Error(`Currency with id ${this.currencyId} is not fa2`);let o=new Go(10).pow(r.decimals),i=await this.getWallet(t.senderAddress),[a,c]=await Promise.all([i.toolkit.wallet.at(this.swapContractAddress),i.toolkit.wallet.at(r.contractAddress)]),m=await Ve.wrapContractCallsWithApprove({toolkit:i.toolkit,ownerAddress:t.senderAddress,approvedAddress:a.address,tokenContract:c,tokenId:r.tokenId,contractCalls:[a.methodsObject.initiate({totalAmount:t.amount.multipliedBy(o),tokenAddress:r.contractAddress,tokenId:r.tokenId,refundTime:this.formatDate(t.refundTimestamp),payoffAmount:t.rewardForRedeem.multipliedBy(o),hashedSecret:t.secretHash,participant:t.receivingAddress})]}).send();return this.getTransaction("Lock",m)}getRedeemReward(t){return E.getRedeemRewardInToken(this.currencyId,t,this.priceManager,this.atomexBlockchainProvider)}};var le=class{constructor(e){s(this,"httpClient");this.httpClient=new N(e)}async getBalance(e,t){if(!Ht(t))throw new Error("Not tezos blockchain currency provided");switch(t.type){case"native":return await this.getNativeTokenBalance(e,t);case"fa1.2":case"fa2":return await this.getTokenBalance(e,t)}}async getNativeTokenBalance(e,t){let r=`/v1/accounts/${e}/balance`,o=await this.httpClient.request({urlPath:r},!1);return re(o,t.decimals)}async getTokenBalance(e,t){let r="/v1/tokens/balances",o={account:e,"token.contract":t.contractAddress,"token.tokenId":t.type==="fa1.2"?0:t.tokenId,select:"balance"},i=await this.httpClient.request({urlPath:r,params:o},!1),a=i.length?i[0]:0;if(a===void 0)throw new Error("Invalid response");return re(a,t.decimals)}};var ze=class{constructor(){s(this,"_isStarted",!1)}get isStarted(){return this._isStarted}async start(){this.isStarted||(this._isStarted=!0)}stop(){!this.isStarted||(this._isStarted=!1)}getSwapTransactions(e){throw new Error("Method not implemented.")}};import{TezosToolkit as Qo}from"@taquito/taquito";var jt=class{constructor(e){this.rpcUrl=e;s(this,"toolkitId","taquito");s(this,"toolkit")}getReadonlyToolkit(e){return e&&e!==jt.BLOCKCHAIN?Promise.resolve(void 0):(this.toolkit||(this.toolkit=new Qo(this.rpcUrl)),Promise.resolve(this.toolkit))}},Y=jt;s(Y,"BLOCKCHAIN","tezos");var kr={id:"XTZ",name:"Tezos",symbol:"XTZ",blockchain:"tezos",decimals:6,type:"native"},jo={id:"TZBTC",name:"tzBTC",symbol:"tzBTC",blockchain:"tezos",type:"fa1.2",contractAddress:"KT1PWx2mnDueood7fEmfbBDKx1D9BAnnXitn",decimals:8},Zo={id:"KUSD",name:"Kolibri USD",symbol:"kUSD",blockchain:"tezos",type:"fa1.2",contractAddress:"KT1K9gCRgaLRFKTErYt1wVxA3Frb9FjasjTV",decimals:18},Ar={id:"USDT_XTZ",name:"Tether USD",symbol:"USDt",blockchain:"tezos",type:"fa2",tokenId:0,contractAddress:"KT1XnTn74bUtxHfDtBmm2bGZAQfhPbvKWR8o",decimals:6},Xe=[kr,jo,Zo,Ar],Je=[kr,S(x({},Ar),{contractAddress:"KT1BWvRQnVVowZZLGkct9A7sdj5YEe8CdUhR"})];var Ye={atomexProtocolVersion:1,initiateOperation:{fee:11e3,gasLimit:11e4,storageLimit:350},redeemOperation:{fee:11e3,gasLimit:15e3,storageLimit:257},refundOperation:{fee:11e3,gasLimit:11e4,storageLimit:257}},Tr={atomexProtocolVersion:1,initiateOperation:{fee:35e4,gasLimit:4e5,storageLimit:250},redeemOperation:{fee:12e4,gasLimit:4e5,storageLimit:257},refundOperation:{fee:12e4,gasLimit:4e5,storageLimit:257}};var Cr={atomexProtocolVersion:1,initiateOperation:{fee:35e4,gasLimit:4e5,storageLimit:250},redeemOperation:{fee:12e4,gasLimit:4e5,storageLimit:257},refundOperation:{fee:12e4,gasLimit:4e5,storageLimit:257}};var Vo={atomexProtocolVersion:1,currencyId:"XTZ",swapContractAddress:"KT1VG2WtYdSWz5E7chTeAdDPZNy2MpP8pTfL",swapContractBlockId:"513046",initiateOperation:{fee:2e3,gasLimit:11e3,storageLimit:257},redeemOperation:{fee:2e3,gasLimit:15e3,storageLimit:257},refundOperation:{fee:1600,gasLimit:13e3,storageLimit:257}},Xo=S(x({},Ye),{currencyId:"TZBTC",swapContractAddress:"KT1Ap287P1NzsnToSJdA4aqSNjPomRaHBZSr",swapContractBlockId:"900350",redeemOperation:S(x({},Ye.redeemOperation),{gasLimit:18e4})}),Jo=S(x({},Ye),{currencyId:"KUSD",swapContractAddress:"KT1EpQVwqLGSH7vMCWKJnq6Uxi851sEDbhWL",swapContractBlockId:"1358868",redeemOperation:S(x({},Ye.redeemOperation),{gasLimit:11e4})}),Yo=S(x({},Tr),{currencyId:"USDT_XTZ",swapContractAddress:"KT1Ays1Chwx3ArnHGoQXchUgDsvKe9JboUjj",swapContractBlockId:"2496680"}),et={XTZ:Vo,TZBTC:Xo,KUSD:Jo,USDT_XTZ:Yo};var en={atomexProtocolVersion:1,currencyId:"XTZ",swapContractAddress:"KT1SJMtHZFSPva5AzQEx5btBuQ8BjvXqort3",swapContractBlockId:"320132",initiateOperation:{fee:2e3,gasLimit:11e3,storageLimit:257},redeemOperation:{fee:2e3,gasLimit:15e3,storageLimit:257},refundOperation:{fee:1600,gasLimit:13e3,storageLimit:257}},tn=S(x({},Cr),{currencyId:"USDT_XTZ",swapContractAddress:"KT1HHjNxi3okxxGJT1SPPhpcs3gMQt8hqixY",swapContractBlockId:"734339"}),vt={XTZ:en,USDT_XTZ:tn};var rn=(n,e,t)=>{switch(e.type){case"native":return new V(n.atomexNetwork,t,n.providers.blockchainProvider,n.managers.walletsManager,n.managers.priceManager);case"fa1.2":return new X(n.atomexNetwork,t,n.providers.blockchainProvider,n.managers.walletsManager,n.managers.priceManager);case"fa2":return new J(n.atomexNetwork,t,n.providers.blockchainProvider,n.managers.walletsManager,n.managers.priceManager);default:throw new Error(`Unknown Tezos currency: ${e.id}`)}},Mr=(n,e,t)=>{let r={},o=e.reduce((i,a)=>(i[a.id]=a,i),{});for(let i of Object.values(t)){let a=o[i.currencyId];if(!a)throw new Error(`The ${i.currencyId} currency not found`);r[a.id]={atomexProtocol:rn(n,a,i)}}return r},St=n=>{let e="https://rpc.tzkt.io/mainnet/",t="https://rpc.tzkt.io/ithacanet/",r=new ze;return n.atomexNetwork==="mainnet"?{rpcUrl:e,currencies:Xe,currencyOptions:Mr(n,Xe,et),blockchainToolkitProvider:new Y(e),balancesProvider:new le("https://api.mainnet.tzkt.io/"),swapTransactionsProvider:r}:{rpcUrl:t,currencies:Je,currencyOptions:Mr(n,Je,vt),blockchainToolkitProvider:new Y(t),balancesProvider:new le("https://api.ghostnet.tzkt.io/"),swapTransactionsProvider:r}};import z from"bignumber.js";var Pt=n=>n.map(t=>on(t)),on=n=>{let[e,t]=b.getBaseQuoteCurrenciesBySymbol(n.symbol);return{ask:new z(n.ask),bid:new z(n.bid),symbol:n.symbol,timeStamp:new Date(n.timeStamp),baseCurrency:e,quoteCurrency:t}},nn=(n,e,t=9)=>{var d,l;let[r,o]=b.getBaseQuoteCurrenciesBySymbol(n.name),i=(d=e.getCurrency(r))==null?void 0:d.decimals,a=(l=e.getCurrency(o))==null?void 0:l.decimals,c=i?Math.min(i,t):t,m=a?Math.min(a,t):t;return{name:n.name,baseCurrency:r,quoteCurrency:o,minimumQty:new z(n.minimumQty),decimals:{baseCurrency:c,quoteCurrency:m,price:t}}},Or=(n,e,t)=>n.map(r=>nn(r,e,t)),kt=n=>{let[e,t]=b.getBaseQuoteCurrenciesBySymbol(n.symbol);return{updateId:n.updateId,symbol:n.symbol,baseCurrency:e,quoteCurrency:t,entries:n.entries.map(o=>Ir(o))}},Ir=n=>({side:n.side,price:new z(n.price),qtyProfile:n.qtyProfile}),zr=(n,e)=>{let t=new Map;for(let r of n){let o=t.get(r.symbol)||e.getOrderBook(r.symbol);if(!o)continue;let i=Ir(r),a=o.entries.find(d=>d.side===i.side&&d.price.isEqualTo(i.price)),c=r.qtyProfile.length?a?o.entries.map(d=>d===a?S(x({},d),{qtyProfile:i.qtyProfile}):d):[...o.entries,i]:o.entries.filter(d=>d!==a),m=S(x({},o),{updateId:r.updateId,entries:c});t.set(m.symbol,m)}return Array.from(t.values())},Zt=(n,e)=>{var i;let t=e.getSymbol(n.symbol);if(!t)throw new Error(`"${n.symbol}" symbol not found`);let[r,o]=b.convertSymbolAndSideToFromAndToSymbolCurrencies(t,n.side,n.qty,n.price);return{id:n.id,from:r,to:o,clientOrderId:n.clientOrderId,side:n.side,symbol:n.symbol,leaveQty:new z(n.leaveQty),timeStamp:new Date(n.timeStamp),type:n.type,status:n.status,swapIds:((i=n.swaps)==null?void 0:i.map(a=>a.id))||[]}},Nr=(n,e)=>n.map(t=>Zt(t,e)),Br=n=>n.map(t=>({id:t.txId,blockId:t.blockHeight,confirmations:t.confirmations,currencyId:t.currency,status:t.status,type:t.type})),tt=(n,e)=>{let t=e.getSymbol(n.symbol);if(!t)throw new Error(`"${n.symbol}" symbol not found`);let[r,o]=b.convertSymbolAndSideToFromAndToSymbolCurrencies(t,n.side,n.qty,n.price);return{isInitiator:n.isInitiator,secret:n.secret,secretHash:n.secretHash,id:Number(n.id),from:r,to:o,trade:{qty:new z(n.qty),price:new z(n.price),side:n.side,symbol:n.symbol},timeStamp:new Date(n.timeStamp),counterParty:{status:n.counterParty.status,transactions:Br(n.counterParty.transactions),requisites:S(x({},n.counterParty.requisites),{rewardForRedeem:new z(n.counterParty.requisites.rewardForRedeem)}),trades:Er(n.counterParty.trades)},user:{status:n.user.status,transactions:Br(n.user.transactions),requisites:S(x({},n.user.requisites),{rewardForRedeem:new z(n.user.requisites.rewardForRedeem)}),trades:Er(n.user.trades)}}},Er=n=>n.map(t=>({orderId:t.orderId,price:new z(t.price),qty:new z(t.qty)})),Rr=(n,e)=>n.map(t=>tt(t,e)),Fr=(n,e)=>{let t=e.getSymbol(n.symbol);if(!t)throw new Error(`"${n.symbol}" symbol not found`);let[r,o]=b.convertSymbolAndSideToFromAndToSymbolCurrencies(t,n.side,n.qty,n.price);return{id:n.id,clientOrderId:n.clientOrderId,side:n.side,status:n.status,leaveQty:new z(n.leaveQty),swapIds:n.swaps,symbol:n.symbol,type:n.type,timeStamp:new Date(n.timeStamp),from:r,to:o}};var pe=class{constructor(e){s(this,"atomexNetwork");s(this,"events",{swapUpdated:new g,orderUpdated:new g,orderBookSnapshot:new g,orderBookUpdated:new g,topOfBookUpdated:new g});s(this,"authorizationManager");s(this,"currenciesProvider");s(this,"exchangeSymbolsProvider");s(this,"apiBaseUrl");s(this,"httpClient");s(this,"_isStarted",!1);this.atomexNetwork=e.atomexNetwork,this.authorizationManager=e.authorizationManager,this.currenciesProvider=e.currenciesProvider,this.exchangeSymbolsProvider=e.exchangeSymbolsProvider,this.apiBaseUrl=e.apiBaseUrl,this.httpClient=new N(this.apiBaseUrl)}get isStarted(){return this._isStarted}async start(){this.isStarted||(this._isStarted=!0)}stop(){!this.isStarted||(this._isStarted=!1)}async getOrder(e,t){let r=`/v1/Orders/${t}`,o=this.getRequiredAuthToken(e),i=await this.httpClient.request({urlPath:r,authToken:o});return i?Zt(i,this.exchangeSymbolsProvider):void 0}async getOrders(e,t){let r="/v1/Orders",o=this.getRequiredAuthToken(e),i=S(x({},t),{sortAsc:void 0,sort:(t==null?void 0:t.sortAsc)!==void 0?t.sortAsc?"Asc":"Desc":void 0}),a=await this.httpClient.request({urlPath:r,authToken:o,params:i});return a?Nr(a,this.exchangeSymbolsProvider):[]}async getSymbols(){let e="/v1/Symbols",t=await this.httpClient.request({urlPath:e});return t?Or(t,this.currenciesProvider):[]}async getTopOfBook(e){let t="/v1/MarketData/quotes",r;if(e!=null&&e.length)if(typeof e[0]=="string")r=e;else{let a=this.exchangeSymbolsProvider.getSymbolsMap();r=e.map(c=>b.convertFromAndToCurrenciesToSymbolAndSide(a,c.from,c.to)[0].name)}let o={symbols:r==null?void 0:r.join(",")},i=await this.httpClient.request({urlPath:t,params:o});return i?Pt(i):[]}async getOrderBook(e){let t="/v1/MarketData/book",r;if(typeof e=="string")r=e;else{let a=this.exchangeSymbolsProvider.getSymbolsMap();r=b.convertFromAndToCurrenciesToSymbolAndSide(a,e.from,e.to)[0].name}let o={symbol:r},i=await this.httpClient.request({urlPath:t,params:o});return i?kt(i):void 0}async addOrder(e,t){let r="/v1/Orders",o=this.getRequiredAuthToken(e),i,a,c,m;if(B.isOrderPreview(t.orderBody)){i=t.orderBody.symbol,a=t.orderBody.side;let v=b.getBaseQuoteCurrenciesBySymbol(i)[0]===t.orderBody.from.currencyId?"from":"to";c=t.orderBody[v].amount,m=t.orderBody[v].price}else[i,a]=[t.orderBody.symbol,t.orderBody.side],c=t.orderBody.amount,m=t.orderBody.price;let d={clientOrderId:t.clientOrderId,symbol:i,side:a,type:t.orderBody.type,requisites:t.requisites?{secretHash:t.requisites.secretHash,receivingAddress:t.requisites.receivingAddress,refundAddress:t.requisites.refundAddress,rewardForRedeem:t.requisites.rewardForRedeem.toNumber(),lockTime:t.requisites.lockTime,quoteCurrencyContract:t.requisites.quoteCurrencyContract,baseCurrencyContract:t.requisites.baseCurrencyContract}:void 0,proofsOfFunds:t.proofsOfFunds.map(p=>({address:p.address,currency:p.currency,timeStamp:p.timeStamp,message:p.message,publicKey:p.publicKey,signature:p.signature,algorithm:p.algorithm})),qty:c.toNumber(),price:m.toNumber()},l=await this.httpClient.request({urlPath:r,authToken:o,method:"POST",payload:d});if(l===void 0)throw new Error("Unexpected response dto");return l.orderId}async cancelOrder(e,t){let r=`/v1/Orders/${t.orderId}`,o=this.getRequiredAuthToken(e),i,a;if(t.symbol&&t.side)[i,a]=[t.symbol,t.side];else if(t.from&&t.to){let d=this.exchangeSymbolsProvider.getSymbolsMap(),l=b.convertFromAndToCurrenciesToSymbolAndSide(d,t.from,t.to);i=l[0].name,a=l[1]}else throw new Error("Invalid cancelOrderRequest argument passed");let c={symbol:i,side:a},m=await this.httpClient.request({urlPath:r,authToken:o,params:c,method:"DELETE"});if(m===void 0)throw new Error("Unexpected response dto");return m}async cancelAllOrders(e,t){let r="/v1/Orders",o=this.getRequiredAuthToken(e),i,a;if(t.symbol&&t.side)[i,a]=[t.symbol,t.side];else if(t.from&&t.to){let m=this.exchangeSymbolsProvider.getSymbolsMap(),d=b.convertFromAndToCurrenciesToSymbolAndSide(m,t.from,t.to);i=d[0].name,a=d[1],t.cancelAllDirections&&(a="All")}else throw new Error("Invalid cancelAllOrdersRequest argument passed");let c=await this.httpClient.request({urlPath:r,authToken:o,params:{symbol:i,side:a,forAllConnections:t.forAllConnections},method:"DELETE"});if(c===void 0)throw new Error("Unexpected response dto");return c}getSwapTransactions(e){throw new Error("Method not implemented.")}async getSwap(e,t){let r=`/v1/Swaps/${e}`,i={userIds:this.getUserIds(t).join(",")},a=await this.httpClient.request({urlPath:r,params:i});return a?tt(a,this.exchangeSymbolsProvider):void 0}async getSwaps(e,t){let r="/v1/Swaps",o=this.getUserIds(e),i=S(x({},t),{sortAsc:void 0,sort:(t==null?void 0:t.sortAsc)!==void 0?t.sortAsc?"Asc":"Desc":void 0,userIds:o.join(",")}),a=await this.httpClient.request({urlPath:r,params:i});return a?Rr(a,this.exchangeSymbolsProvider):[]}getUserIds(e){let r=(Array.isArray(e)?e:[e]).map(o=>{var i;return(i=this.authorizationManager.getAuthToken(o))==null?void 0:i.userId}).filter(o=>o);if(!r.length)throw new Error("Incorrect accountAddresses");return r}getRequiredAuthToken(e){var r;let t=(r=this.authorizationManager.getAuthToken(e))==null?void 0:r.value;if(!t)throw new Error(`Cannot find auth token for address: ${e}`);return t}};var ue=class{constructor(e,t){this.url=e;this.authToken=t;s(this,"events",{messageReceived:new g,closed:new g});s(this,"_socket");s(this,"onMessageReceived",e=>{this.events.messageReceived.emit(JSON.parse(e.data))});s(this,"onClosed",e=>{this.events.closed.emit(this,e)})}get socket(){if(!this._socket)throw new Error("Internal websocket is not created. Use the connect method first");return this._socket}async connect(){return this.disconnect(),new Promise(e=>{let t=this.authToken?["access_token",this.authToken]:void 0;this._socket=new WebSocket(this.url,t),this.socket.addEventListener("message",this.onMessageReceived),this.socket.addEventListener("error",this.onError),this.socket.addEventListener("close",this.onClosed),this.socket.addEventListener("open",()=>e())})}disconnect(){this._socket&&(this.socket.removeEventListener("message",this.onMessageReceived),this.socket.removeEventListener("error",this.onError),this.socket.removeEventListener("close",this.onClosed),this.socket.close())}subscribe(e){let t={method:"subscribe",data:e,requestId:Date.now()};this.socket.send(JSON.stringify(t))}unsubscribe(e){let t={method:"unsubscribe",data:e,requestId:Date.now()};this.socket.send(JSON.stringify(t))}onError(e){throw new Error(`Websocket received error: ${JSON.stringify(e)}`)}};var Vt=class{constructor(e,t){this.webSocketApiBaseUrl=e;this.authorizationManager=t;s(this,"events",{messageReceived:new g});s(this,"sockets",new Map);s(this,"_isStarted",!1);s(this,"reconnectScheduler",new ne([1e3,5e3,3e4,6e4],12e4));s(this,"onAuthorized",async e=>{this.removeSocket(e.userId);let t=new ue(new URL(Vt.EXCHANGE_URL_PATH,this.webSocketApiBaseUrl),e.value);t.events.messageReceived.addListener(this.onSocketMessageReceived),t.events.closed.addListener(this.onClosed),this.sockets.set(e.userId,t),await t.connect()});s(this,"onUnauthorized",e=>{this.removeSocket(e.userId)});s(this,"onSocketMessageReceived",e=>{this.events.messageReceived.emit(e)});s(this,"onClosed",(e,t)=>{this.reconnectScheduler.setTimeout(()=>{e.connect()})})}get isStarted(){return this._isStarted}async start(){this.isStarted||(this.subscribeOnAuthEvents(),this._isStarted=!0)}stop(){!this.isStarted||(this.sockets.forEach((e,t)=>{this.removeSocket(t)}),this.reconnectScheduler.dispose(),this._isStarted=!1)}subscribeOnAuthEvents(){this.authorizationManager.events.authorized.addListener(this.onAuthorized),this.authorizationManager.events.unauthorized.addListener(this.onUnauthorized)}removeSocket(e){let t=this.sockets.get(e);t&&(t.events.messageReceived.removeListener(this.onSocketMessageReceived),t.events.closed.removeListener(this.onClosed),this.sockets.delete(e),t.disconnect())}},Ne=Vt;s(Ne,"EXCHANGE_URL_PATH","/ws/exchange");var rt=class{constructor(e){this.webSocketApiBaseUrl=e;s(this,"events",{messageReceived:new g});s(this,"socket");s(this,"_isStarted",!1);s(this,"reconnectScheduler",new ne([1e3,5e3,3e4,6e4],12e4));s(this,"onSocketClosed",(e,t)=>{this.reconnectScheduler.setTimeout(async()=>{await e.connect(),this.subscribeOnStreams(e)})});s(this,"onSocketMessageReceived",e=>{this.events.messageReceived.emit(e)});this.socket=new ue(new URL(rt.MARKET_DATA_URL_PATH,this.webSocketApiBaseUrl))}get isStarted(){return this._isStarted}async start(){this.isStarted||(this.socket.events.messageReceived.addListener(this.onSocketMessageReceived),this.socket.events.closed.addListener(this.onSocketClosed),await this.socket.connect(),this.subscribeOnStreams(this.socket),this._isStarted=!0)}stop(){!this.isStarted||(this.socket.events.messageReceived.removeListener(this.onSocketMessageReceived),this.socket.events.closed.removeListener(this.onSocketClosed),this.socket.disconnect(),this.reconnectScheduler.dispose(),this._isStarted=!1)}subscribeOnStreams(e){e.subscribe(rt.TOP_OF_BOOK_STREAM),e.subscribe(rt.ORDER_BOOK_STREAM)}},ee=rt;s(ee,"MARKET_DATA_URL_PATH","/ws/marketdata"),s(ee,"TOP_OF_BOOK_STREAM","topOfBook"),s(ee,"ORDER_BOOK_STREAM","orderBook");var he=class{constructor(e){s(this,"atomexNetwork");s(this,"events",{swapUpdated:new g,orderUpdated:new g,orderBookSnapshot:new g,orderBookUpdated:new be,topOfBookUpdated:new g});s(this,"authorizationManager");s(this,"exchangeSymbolsProvider");s(this,"currenciesProvider");s(this,"webSocketApiBaseUrl");s(this,"marketDataWebSocketClient");s(this,"exchangeWebSocketClient");s(this,"orderBookProvider");s(this,"_isStarted",!1);s(this,"onSocketMessageReceived",e=>{switch(e.event){case"order":this.events.orderUpdated.emit(Fr(e.data,this.exchangeSymbolsProvider));break;case"swap":this.events.swapUpdated.emit(tt(e.data,this.exchangeSymbolsProvider));break;case"topOfBook":this.events.topOfBookUpdated.emit(Pt(e.data));break;case"snapshot":this.onOrderBookSnapshotReceived(e.data);break;case"entries":this.onOrderBookEntriesReceived(e.data);break}});this.atomexNetwork=e.atomexNetwork,this.authorizationManager=e.authorizationManager,this.currenciesProvider=e.currenciesProvider,this.exchangeSymbolsProvider=e.exchangeSymbolsProvider,this.orderBookProvider=e.orderBookProvider,this.webSocketApiBaseUrl=e.webSocketApiBaseUrl,this.exchangeWebSocketClient=new Ne(this.webSocketApiBaseUrl,this.authorizationManager),this.marketDataWebSocketClient=new ee(this.webSocketApiBaseUrl)}get isStarted(){return this._isStarted}async start(){this.isStarted||(this.exchangeWebSocketClient.events.messageReceived.addListener(this.onSocketMessageReceived),this.marketDataWebSocketClient.events.messageReceived.addListener(this.onSocketMessageReceived),await Promise.all([this.exchangeWebSocketClient.start(),this.marketDataWebSocketClient.start()]),this._isStarted=!0)}stop(){!this.isStarted||(this.exchangeWebSocketClient.events.messageReceived.removeListener(this.onSocketMessageReceived),this.marketDataWebSocketClient.events.messageReceived.removeListener(this.onSocketMessageReceived),this.exchangeWebSocketClient.stop(),this.marketDataWebSocketClient.stop(),this._isStarted=!1)}getOrder(e,t){throw new Error("Method not implemented.")}getOrders(e,t){throw new Error("Method not implemented.")}getSymbols(){throw new Error("Method not implemented.")}getTopOfBook(e){throw new Error("Method not implemented.")}async getOrderBook(e){throw new Error("Method not implemented.")}addOrder(e,t){throw new Error("Method not implemented.")}cancelOrder(e,t){throw new Error("Method not implemented.")}cancelAllOrders(e,t){throw new Error("Method not implemented.")}getSwapTransactions(e){throw new Error("Method not implemented.")}getSwap(e,t){throw new Error("Method not implemented.")}getSwaps(e,t){throw new Error("Method not implemented.")}onOrderBookSnapshotReceived(e){let t=kt(e);this.orderBookProvider.setOrderBook(t.symbol,t),this.events.orderBookSnapshot.emit(t)}onOrderBookEntriesReceived(e){let t=zr(e,this.orderBookProvider);for(let r of t)this.orderBookProvider.setOrderBook(r.symbol,r),this.events.orderBookUpdated.emit(r.symbol,r)}};var Re=class{constructor(e,t,r){this.atomexNetwork=e;this.restAtomexClient=t;this.webSocketAtomexClient=r;s(this,"events");s(this,"_isStarted",!1);R.ensureNetworksAreSame(this,t),R.ensureNetworksAreSame(this,r),this.events={swapUpdated:this.webSocketAtomexClient.events.swapUpdated,orderBookSnapshot:this.webSocketAtomexClient.events.orderBookSnapshot,orderBookUpdated:this.webSocketAtomexClient.events.orderBookUpdated,orderUpdated:this.webSocketAtomexClient.events.orderUpdated,topOfBookUpdated:this.webSocketAtomexClient.events.topOfBookUpdated}}get isStarted(){return this._isStarted}async start(){this.isStarted||(await Promise.all([this.webSocketAtomexClient.start(),this.restAtomexClient.start()]),this._isStarted=!0)}stop(){!this.isStarted||(this.webSocketAtomexClient.stop(),this.restAtomexClient.stop(),this._isStarted=!1)}getOrder(e,t){return this.restAtomexClient.getOrder(e,t)}getOrders(e,t){return this.restAtomexClient.getOrders(e,t)}getSymbols(){return this.restAtomexClient.getSymbols()}getTopOfBook(e){return this.restAtomexClient.getTopOfBook(e)}async getOrderBook(e){return this.restAtomexClient.getOrderBook(e)}addOrder(e,t){return this.restAtomexClient.addOrder(e,t)}cancelOrder(e,t){return this.restAtomexClient.cancelOrder(e,t)}cancelAllOrders(e,t){return this.restAtomexClient.cancelAllOrders(e,t)}getSwapTransactions(e){return this.restAtomexClient.getSwapTransactions(e)}getSwap(e,t){return this.restAtomexClient.getSwap(e,t)}getSwaps(e,t){return this.restAtomexClient.getSwaps(e,t)}};var Xt=(n,e)=>new Re(n.atomexNetwork,new pe({atomexNetwork:n.atomexNetwork,authorizationManager:n.managers.authorizationManager,currenciesProvider:n.providers.currenciesProvider,exchangeSymbolsProvider:n.providers.exchangeSymbolsProvider,apiBaseUrl:e.apiBaseUrl}),new he({atomexNetwork:n.atomexNetwork,authorizationManager:n.managers.authorizationManager,currenciesProvider:n.providers.currenciesProvider,exchangeSymbolsProvider:n.providers.exchangeSymbolsProvider,orderBookProvider:n.providers.orderBookProvider,webSocketApiBaseUrl:e.webSocketApiBaseUrl}));var ot=(r=>(r[r.Local=1]="Local",r[r.Remote=2]="Remote",r[r.All=3]="All",r))(ot||{});var nt=class{constructor(e){s(this,"events",{authorized:new g,unauthorized:new g,authTokenExpiring:new g,authTokenExpired:new g});s(this,"atomexNetwork");s(this,"walletsManager");s(this,"store");s(this,"authorizationUrl");s(this,"expiringNotificationTimeInSeconds");s(this,"_authTokenData",new Map);s(this,"_isStarted",!1);s(this,"authTokenExpiringTimeoutCallback",e=>{let t=this._authTokenData.get(e.address);if(!t)return;clearTimeout(t.watcherId);let r=e.expired.getTime()-Date.now(),o=setTimeout(this.authTokenExpiredTimeoutCallback,Et(r),e);this._authTokenData.set(e.address,S(x({},t),{watcherId:o})),this.events.authTokenExpiring.emit(e)});s(this,"authTokenExpiredTimeoutCallback",e=>{this.unregisterAuthToken(e),this.events.authTokenExpired.emit(e)});this.atomexNetwork=e.atomexNetwork,this.store=e.store,this.walletsManager=e.walletsManager,R.ensureNetworksAreSame(this,this.walletsManager),this.authorizationUrl=new URL(nt.DEFAULT_GET_AUTH_TOKEN_URI,e.authorizationBaseUrl),this.expiringNotificationTimeInSeconds=e.expiringNotificationTimeInSeconds||nt.DEFAULT_EXPIRING_NOTIFICATION_TIME_IN_SECONDS}get isStarted(){return this._isStarted}async start(){this.isStarted||(this._isStarted=!0)}stop(){if(!!this.isStarted){for(let e of this.authTokenData)this.untrackAuthToken(e[1].watcherId);this._isStarted=!1}}get authTokenData(){return this._authTokenData}getAuthToken(e){var t;return(t=this.authTokenData.get(e))==null?void 0:t.authToken}async authorize({address:e,authTokenSource:t=3,blockchain:r,authMessage:o=nt.DEFAULT_AUTH_MESSAGE}){if((t&1)===1){let p=this.getAuthToken(e)||await this.loadAuthTokenFromStore(e);if(p&&!this.isTokenExpiring(p))return p}if((t&2)!==2)return;let i=await this.walletsManager.getWallet(e,r);if(!i)throw new Error(`Not found: the corresponding wallet by the ${e} address`);let a=this.getAuthorizationTimeStamp(o),c=await i.sign(o+a);if(c.address!==e)throw new Error("Invalid address in the signed data");let m={message:o,publicKey:c.publicKeyBytes,algorithm:c.algorithm,signingDataType:c.signingDataType,signature:c.signatureBytes,timeStamp:a},d=await this.requestAuthToken(m),l={value:d.token,userId:d.id,address:e,expired:new Date(d.expires),request:m};return await this.registerAuthToken(l,!0),l}async unauthorize(e){let t=this.getAuthToken(e);return t?this.unregisterAuthToken(t):!1}async loadAuthTokenFromStore(e){let t=await this.store.getAuthToken(e);if(!!t)return await this.registerAuthToken(t,!1)}async registerAuthToken(e,t){let r=this.trackAuthToken(e);if(!r)return;let o={authToken:e,watcherId:r};return this._authTokenData.set(e.address,o),t&&(e=await this.store.upsertAuthToken(e.address,e)),this.events.authorized.emit(e),e}async unregisterAuthToken(e){let t=this._authTokenData.get(e.address);if(!t)return!1;this.untrackAuthToken(t.watcherId);let r=await this.store.removeAuthToken(e)&&this._authTokenData.delete(e.address);return r&&this.events.unauthorized.emit(e),r}trackAuthToken(e){let t=e.expired.getTime()-Date.now();if(t<=0){this.store.removeAuthToken(e),this.events.authTokenExpired.emit(e);return}let r=t-this.expiringNotificationTimeInSeconds*1e3;return setTimeout(this.authTokenExpiringTimeoutCallback,Et(r),e)}untrackAuthToken(e){clearTimeout(e)}getAuthorizationTimeStamp(e){return Date.now()}async requestAuthToken(e){let t=await fetch(this.authorizationUrl.href,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(await t.text());return t.json()}isTokenExpiring(e){return e.expired.getTime()-Date.now()<=this.expiringNotificationTimeInSeconds*1e3}},L=nt;s(L,"DEFAULT_AUTH_MESSAGE","Signing in "),s(L,"DEFAULT_GET_AUTH_TOKEN_URI","/v1/token"),s(L,"DEFAULT_EXPIRING_NOTIFICATION_TIME_IN_SECONDS",60);var ye=class{mapAuthTokenToSerializedAuthToken(e){return{a:e.address,u:e.userId,e:e.expired.getTime(),v:e.value,r:this.mapAuthTokenRequestDataToSerializedAuthTokenRequestData(e.request)}}mapSerializedAuthTokenToAuthToken(e){return e.r?{address:e.a,userId:e.u,expired:new Date(e.e),value:e.v,request:this.mapSerializedAuthTokenRequestDataToAuthTokenRequestData(e.r)}:null}mapAuthTokenRequestDataToSerializedAuthTokenRequestData(e){return{m:e.message,t:e.timeStamp,pk:e.publicKey,s:e.signature,a:e.algorithm,sdt:e.signingDataType}}mapSerializedAuthTokenRequestDataToAuthTokenRequestData(e){return{message:e.m,timeStamp:e.t,publicKey:e.pk,signature:e.s,algorithm:e.a,signingDataType:e.sdt}}};var Jt=class{constructor(e,t,r=Jt.DefaultKeyPrefix){this.localStorage=e;this.serializedAuthTokenMapper=t;this.keyPrefix=r}getAuthToken(e){let t=localStorage.getItem(this.getKey(e));return t&&this.serializedAuthTokenMapper.mapSerializedAuthTokenToAuthToken(JSON.parse(t))||void 0}getAuthTokens(e){return e.map(t=>this.getAuthToken(t)).filter(Boolean)}upsertAuthToken(e,t){let r=this.serializedAuthTokenMapper.mapAuthTokenToSerializedAuthToken(t);if(!r)throw new Error(`The authToken of the ${e} address can't be stored: serialization is failed`);return localStorage.setItem(this.getKey(e),JSON.stringify(r)),t}removeAuthToken(e){return localStorage.removeItem(this.getKey(e)),!0}getKey(e){return this.keyPrefix+e}},it=Jt;s(it,"DefaultKeyPrefix","authToken:");var Yt=class{constructor(e,t,r=Yt.DefaultKeyPrefix){this.localStorage=e;this.serializedAuthTokenMapper=t;this.keyPrefix=r}get key(){return this.keyPrefix}getAuthToken(e){let t=this.getSerializedAuthTokensStoreObject();return t[e]&&(this.serializedAuthTokenMapper.mapSerializedAuthTokenToAuthToken(t[e])||void 0)}getAuthTokens(e){let t=this.getSerializedAuthTokensStoreObject();return Object.values(t).map(r=>this.serializedAuthTokenMapper.mapSerializedAuthTokenToAuthToken(r)).filter(r=>!!r&&e.indexOf(r.address)>-1)}upsertAuthToken(e,t){let r=this.getSerializedAuthTokensStoreObject(),o=this.serializedAuthTokenMapper.mapAuthTokenToSerializedAuthToken(t);if(!o)throw new Error(`The authToken of the ${e} address can't be stored: serialization is failed`);return r[e]=o,this.localStorage.setItem(this.key,JSON.stringify(r)),t}removeAuthToken(e){let t=this.getSerializedAuthTokensStoreObject();return t[e]?(delete t[e],Object.keys(t).length?this.localStorage.setItem(this.key,JSON.stringify(t)):this.localStorage.removeItem(this.key),!0):!1}getSerializedAuthTokensStoreObject(){let e=this.localStorage.getItem(this.key);return e?JSON.parse(e):{}}},at=Yt;s(at,"DefaultKeyPrefix","authTokens");var ge=class{constructor(e="single-key",t=new ye){s(this,"storeStrategy");this.storeStrategy=typeof e=="string"?this.createPreDefinedStoreStrategy(e,t):e}getAuthToken(e){return Promise.resolve(this.storeStrategy.getAuthToken(e))}getAuthTokens(...e){return Promise.resolve(this.storeStrategy.getAuthTokens(e))}upsertAuthToken(e,t){return Promise.resolve(this.storeStrategy.upsertAuthToken(e,t))}removeAuthToken(e){let t=typeof e=="string"?e:e.address;return Promise.resolve(this.storeStrategy.removeAuthToken(t))}createPreDefinedStoreStrategy(e,t){switch(e){case"single-key":return new at(globalThis.localStorage,t);case"multiple-keys":return new it(globalThis.localStorage,t);default:throw new Error(`Unknown the store strategy name: ${e}`)}}};var Fe=class{constructor(){s(this,"authTokensMap",new Map)}getAuthToken(e){return Promise.resolve(this.authTokensMap.get(e))}getAuthTokens(...e){return Promise.resolve(e.reduce((t,r)=>{let o=this.authTokensMap.get(r);return o&&t.push(o),t},[]))}upsertAuthToken(e,t){return this.authTokensMap.set(e,t),Promise.resolve(t)}removeAuthToken(e){let t=typeof e=="string"?e:e.address;return Promise.resolve(this.authTokensMap.delete(t))}};var er=(n,e,t)=>{let r=globalThis.window?"browser":"node";return new L({atomexNetwork:n.atomexNetwork,walletsManager:n.managers.walletsManager,authorizationBaseUrl:e.authorizationBaseUrl,store:r==="browser"?new ge(e.store.browser.storeStrategy):new Fe})};var _r="https://api.atomex.me",an={authorization:{authorizationBaseUrl:_r,store:{node:{},browser:{storeStrategy:"single-key"}}},exchange:{apiBaseUrl:_r,webSocketApiBaseUrl:"wss://api.atomex.me"}},Wr="https://api.test.atomex.me",sn={authorization:{authorizationBaseUrl:Wr,store:{node:{},browser:{storeStrategy:"single-key"}}},exchange:{apiBaseUrl:Wr,webSocketApiBaseUrl:"wss://ws.api.test.atomex.me"}},tr={mainnet:an,testnet:sn};var fe=class{constructor(e,t=new ke(e.atomexNetwork)){this.options=e;this.atomexContext=t;s(this,"customAuthorizationManagerFactory");s(this,"customWalletsManagerFactory");s(this,"customExchangeManagerFactory")}get controlledAtomexContext(){return this.atomexContext}useAuthorizationManager(e){return this.customAuthorizationManagerFactory=e,this}useWalletsManager(e){return this.customWalletsManagerFactory=e,this}useExchangeManager(e){return this.customExchangeManagerFactory=e,this}build(){let e=new $e;this.controlledAtomexContext.providers.blockchainProvider=e,this.controlledAtomexContext.providers.currenciesProvider=e,this.controlledAtomexContext.providers.exchangeSymbolsProvider=this.createExchangeSymbolsProvider(),this.controlledAtomexContext.providers.orderBookProvider=this.createOrderBookProvider(),this.controlledAtomexContext.managers.walletsManager=this.createWalletsManager(),this.controlledAtomexContext.managers.authorizationManager=this.createAuthorizationManager();let t=this.createDefaultExchangeService();this.controlledAtomexContext.services.exchangeService=t,this.controlledAtomexContext.services.swapService=t,this.controlledAtomexContext.managers.exchangeManager=this.createExchangeManager(),this.controlledAtomexContext.managers.swapManager=this.createSwapManager(),this.controlledAtomexContext.managers.priceManager=this.createPriceManager(),this.controlledAtomexContext.managers.balanceManager=this.createBalanceManager();let r=this.createDefaultBlockchainOptions();return new Pe({atomexContext:this.atomexContext,managers:{walletsManager:this.atomexContext.managers.walletsManager,authorizationManager:this.atomexContext.managers.authorizationManager,exchangeManager:this.atomexContext.managers.exchangeManager,swapManager:this.atomexContext.managers.swapManager,balanceManager:this.atomexContext.managers.balanceManager,priceManager:this.atomexContext.managers.priceManager},blockchains:r})}createExchangeSymbolsProvider(){return new ie}createOrderBookProvider(){return new Se}createAuthorizationManager(){let e=tr[this.atomexContext.atomexNetwork].authorization;return this.customAuthorizationManagerFactory?this.customAuthorizationManagerFactory(this.atomexContext,e,this.options):er(this.atomexContext,e,this.options)}createWalletsManager(){return this.customWalletsManagerFactory?this.customWalletsManagerFactory(this.atomexContext,this.options):new Te(this.atomexContext.atomexNetwork)}createDefaultExchangeService(){let e=tr[this.atomexContext.atomexNetwork].exchange;return Xt(this.atomexContext,e)}createExchangeManager(){return this.customExchangeManagerFactory?this.customExchangeManagerFactory(this.atomexContext,this.options):new ve({authorizationManager:this.atomexContext.managers.authorizationManager,exchangeService:this.atomexContext.services.exchangeService,symbolsProvider:this.atomexContext.providers.exchangeSymbolsProvider,orderBookProvider:this.atomexContext.providers.orderBookProvider})}createSwapManager(){return new ft(this.atomexContext.services.swapService)}createBalanceManager(){return new Ae(this.atomexContext.providers.blockchainProvider)}createDefaultBlockchainOptions(){return{tezos:St(this.atomexContext),ethereum:gt(this.atomexContext)}}createPriceManager(){return new ae(this.atomexContext.providers.currenciesProvider,new Map([["binance",new U],["kraken",new G],["atomex",new se(this.atomexContext.managers.exchangeManager)]]))}};var Dr=n=>new fe(S(x({},n),{atomexNetwork:"mainnet"})).build(),qr=n=>new fe(S(x({},n),{atomexNetwork:"testnet"})).build();var rr={};O(rr,{Atomex:()=>st,EthereumHelpers:()=>mt,FA12Helpers:()=>lt,FA2Helpers:()=>pt,Helpers:()=>xe,TezosHelpers:()=>$,dt2ts:()=>te,now:()=>ct});var u={api:{mainnet:{baseUrl:"https://api.atomex.me"},testnet:{baseUrl:"https://api.test.atomex.me"},localhost:{baseUrl:"http://127.0.0.1:5000"}},blockchains:{ethereum:{rpc:{mainnet:{chainID:1,rpc:"https://mainnet.infura.io/v3/7cd728d2d3384719a630d836f1693c5c",blockTime:10},testnet:{chainID:5,rpc:"https://goerli.infura.io/v3/7cd728d2d3384719a630d836f1693c5c",blockTime:10}}},tezos:{rpc:{mainnet:{chainID:"NetXdQprcVkpaWU",rpc:"https://rpc.tzkt.io/mainnet/",blockTime:30,minimalFees:100,minimalNanotezPerGasUnit:.1,minimalNanotezPerByte:1,costPerByte:250},testnet:{chainID:"NetXnHfVqm9iesp",rpc:"https://rpc.tzkt.io/ithacanet/",blockTime:15,minimalFees:100,minimalNanotezPerGasUnit:.1,minimalNanotezPerByte:1,costPerByte:250}}}},currencies:{ETH:{contracts:{mainnet:{address:"0xe9c251cbb4881f9e056e40135e7d3ea9a7d037df",initiateGasLimitWithoutReward:2e5,initiateGasLimitWithReward:21e4,redeemGasLimit:14e4},testnet:{address:"0x512fe6B803bA327DCeFBF2Cec7De333f761B0f2b",initiateGasLimitWithoutReward:2e5,initiateGasLimitWithReward:21e4,redeemGasLimit:14e4},abi:[{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"Activated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{indexed:!1,internalType:"address",name:"_sender",type:"address"},{indexed:!1,internalType:"uint256",name:"_value",type:"uint256"}],name:"Added",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{indexed:!0,internalType:"address",name:"_participant",type:"address"},{indexed:!1,internalType:"address",name:"_initiator",type:"address"},{indexed:!1,internalType:"uint256",name:"_refundTimestamp",type:"uint256"},{indexed:!1,internalType:"uint256",name:"_countdown",type:"uint256"},{indexed:!1,internalType:"uint256",name:"_value",type:"uint256"},{indexed:!1,internalType:"uint256",name:"_payoff",type:"uint256"},{indexed:!1,internalType:"bool",name:"_active",type:"bool"}],name:"Initiated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{indexed:!1,internalType:"bytes32",name:"_secret",type:"bytes32"}],name:"Redeemed",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"Refunded",type:"event"},{constant:!0,inputs:[{internalType:"bytes32",name:"",type:"bytes32"}],name:"swaps",outputs:[{internalType:"bytes32",name:"hashedSecret",type:"bytes32"},{internalType:"address payable",name:"initiator",type:"address"},{internalType:"address payable",name:"participant",type:"address"},{internalType:"uint256",name:"refundTimestamp",type:"uint256"},{internalType:"uint256",name:"countdown",type:"uint256"},{internalType:"uint256",name:"value",type:"uint256"},{internalType:"uint256",name:"payoff",type:"uint256"},{internalType:"bool",name:"active",type:"bool"},{internalType:"enum Atomex.State",name:"state",type:"uint8"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{internalType:"address payable",name:"_participant",type:"address"},{internalType:"uint256",name:"_refundTimestamp",type:"uint256"},{internalType:"uint256",name:"_payoff",type:"uint256"}],name:"initiate",outputs:[],payable:!0,stateMutability:"payable",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"add",outputs:[],payable:!0,stateMutability:"payable",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"activate",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"},{internalType:"bytes32",name:"_secret",type:"bytes32"}],name:"redeem",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!1,inputs:[{internalType:"bytes32",name:"_hashedSecret",type:"bytes32"}],name:"refund",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"}]},decimals:{original:18,displayed:4},blockchain:"ethereum"},XTZ:{contracts:{mainnet:{address:"KT1VG2WtYdSWz5E7chTeAdDPZNy2MpP8pTfL",redeemTxSize:133,initiateTxSize:200,gasLimit:15e3},testnet:{address:"KT1SJMtHZFSPva5AzQEx5btBuQ8BjvXqort3",redeemTxSize:133,initiateTxSize:200,gasLimit:85e3},entrypoints:{default:{prim:"or",args:[{prim:"or",args:[{prim:"pair",args:[{prim:"address",annots:["%participant"]},{prim:"pair",args:[{prim:"pair",args:[{prim:"bytes",annots:["%hashed_secret"]},{prim:"timestamp",annots:["%refund_time"]}]},{prim:"mutez",annots:["%payoff"]}],annots:["%settings"]}],annots:[":initiate","%initiate"]},{prim:"bytes",annots:[":hashed_secret","%add"]}],annots:["%fund"]},{prim:"or",args:[{prim:"bytes",annots:[":secret","%redeem"]},{prim:"bytes",annots:[":hashed_secret","%refund"]}],annots:["%withdraw"]}]},withdraw:{prim:"or",args:[{prim:"bytes",annots:[":secret","%redeem"]},{prim:"bytes",annots:[":hashed_secret","%refund"]}]},refund:{prim:"bytes",annots:[":hashed_secret"]},redeem:{prim:"bytes",annots:[":secret"]},initiate:{prim:"pair",args:[{prim:"address",annots:["%participant"]},{prim:"pair",args:[{prim:"pair",args:[{prim:"bytes",annots:["%hashed_secret"]},{prim:"timestamp",annots:["%refund_time"]}]},{prim:"mutez",annots:["%payoff"]}],annots:["%settings"]}],annots:[":initiate"]},fund:{prim:"or",args:[{prim:"pair",args:[{prim:"address",annots:["%participant"]},{prim:"pair",args:[{prim:"pair",args:[{prim:"bytes",annots:["%hashed_secret"]},{prim:"timestamp",annots:["%refund_time"]}]},{prim:"mutez",annots:["%payoff"]}],annots:["%settings"]}],annots:[":initiate","%initiate"]},{prim:"bytes",annots:[":hashed_secret","%add"]}]},add:{prim:"bytes",annots:[":hashed_secret"]}}},decimals:{original:6,displayed:3},blockchain:"tezos"},TZBTC:{contracts:{mainnet:{address:"KT1Ap287P1NzsnToSJdA4aqSNjPomRaHBZSr",tokenAddress:"KT1PWx2mnDueood7fEmfbBDKx1D9BAnnXitn",redeemTxSize:133,initiateTxSize:250,gasLimit:1e5},testnet:{address:"KT1Jj1jzDQbDRHt4u7M73DUrBDV1napRbNFr",tokenAddress:"",redeemTxSize:133,initiateTxSize:250,gasLimit:1e5},entrypoints:{default:{prim:"or",args:[{prim:"or",args:[{prim:"pair",args:[{prim:"pair",args:[{prim:"pair",args:[{prim:"bytes",annots:["%hashedSecret"]},{prim:"address",annots:["%participant"]}]},{prim:"pair",args:[{prim:"nat",annots:["%payoffAmount"]},{prim:"timestamp",annots:["%refundTime"]}]}]},{prim:"pair",args:[{prim:"address",annots:["%tokenAddress"]},{prim:"nat",annots:["%totalAmount"]}]}],annots:["%initiate"]},{prim:"bytes",annots:["%redeem"]}]},{prim:"bytes",annots:["%refund"]}]},refund:{prim:"bytes"},redeem:{prim:"bytes"},initiate:{prim:"pair",args:[{prim:"pair",args:[{prim:"pair",args:[{prim:"bytes",annots:["%hashedSecret"]},{prim:"address",annots:["%participant"]}]},{prim:"nat",annots:["%payoffAmount"]},{prim:"timestamp",annots:["%refundTime"]}]},{prim:"address",annots:["%tokenAddress"]},{prim:"nat",annots:["%totalAmount"]}]}}},decimals:{original:8,displayed:4},blockchain:"tezos"},USDT_XTZ:{contracts:{mainnet:{address:"KT1Ays1Chwx3ArnHGoQXchUgDsvKe9JboUjj",tokenAddress:"KT1XnTn74bUtxHfDtBmm2bGZAQfhPbvKWR8o",redeemTxSize:2e4,initiateTxSize:2e4,gasLimit:4e5},testnet:{address:"KT1HHjNxi3okxxGJT1SPPhpcs3gMQt8hqixY",tokenAddress:"KT1BWvRQnVVowZZLGkct9A7sdj5YEe8CdUhR",redeemTxSize:2e4,initiateTxSize:2e4,gasLimit:4e5},entrypoints:{default:{prim:"or",args:[{prim:"or",args:[{prim:"pair",args:[{prim:"pair",args:[{prim:"pair",args:[{prim:"bytes",annots:["%hashedSecret"]},{prim:"address",annots:["%participant"]}]},{prim:"pair",args:[{prim:"nat",annots:["%payoffAmount"]},{prim:"timestamp",annots:["%refundTime"]}]}]},{prim:"pair",args:[{prim:"pair",args:[{prim:"address",annots:["%tokenAddress"]},{prim:"nat",annots:["%tokenId"]}]},{prim:"nat",annots:["%totalAmount"]}]}],annots:["%initiate"]},{prim:"bytes",annots:["%redeem"]}]},{prim:"bytes",annots:["%refund"]}]},refund:{prim:"bytes"},redeem:{prim:"bytes"},initiate:{prim:"pair",args:[{prim:"pair",args:[{prim:"pair",args:[{prim:"bytes",annots:["%hashedSecret"]},{prim:"address",annots:["%participant"]}]},{prim:"nat",annots:["%payoffAmount"]},{prim:"timestamp",annots:["%refundTime"]}]},{prim:"pair",args:[{prim:"address",annots:["%tokenAddress"]},{prim:"nat",annots:["%tokenId"]}]},{prim:"nat",annots:["%totalAmount"]}]}}},decimals:{original:6,displayed:4},blockchain:"tezos"}}};var st=class{constructor(e,t,r){s(this,"_network");s(this,"_baseUrl");s(this,"_authToken");s(this,"_authorizationManager");this._network=e,this._baseUrl=t,this._authToken=r}static create(e){return new st(e=="mainnet"?"mainnet":"testnet",u.api[e].baseUrl)}setAuthorizationManager(e){this._authorizationManager=e}getLocalAuthToken(e){var r;let t=(r=this._authorizationManager)==null?void 0:r.getAuthToken(e);return t==null?void 0:t.value}setAuthToken(e){this._authToken=e}async makeRequest(e,t,r=!1,o,i){let a=new URL(t,this._baseUrl);o!==void 0&&Object.keys(o).forEach(l=>a.searchParams.append(l,o[l]));let c={};if(r){let l=typeof r=="string"?this.getLocalAuthToken(r):this._authToken;if(!l)throw new Error("Auth token is undefined");c.Authorization=`Bearer ${l}`}let m;e==="post"&&i!==void 0&&(m=JSON.stringify(i),c["Content-Type"]="application/json");let d=await fetch(a.toString(),{method:e,headers:c,body:m});if(d.ok)return d.json();{let l=await d.text();throw Error(l)}}async getAuthToken(e){return this.makeRequest("post","/v1/Token",!1,{},e)}async getSymbols(){return this.makeRequest("get","/v1/Symbols",!1)}async getQuotes(e){let t=e!==void 0&&e.length>0?e.join(","):"All";return this.makeRequest("get","/v1/MarketData/quotes",!1,{symbols:t})}async getOrderBook(e){return this.makeRequest("get","/v1/MarketData/book",!1,{symbol:e})}async addOrder(e){var i;let[t,r]=this.splitSymbol(e.symbol).map(a=>this.getCurrencyConfig(a)),o=e;return o.requisites=x({baseCurrencyContract:t.contractAddress,quoteCurrencyContract:r.contractAddress},o.requisites),this.makeRequest("post","/v1/Orders",((i=e.requisites)==null?void 0:i.receivingAddress)||!0,{},o).then(a=>a.orderId)}async getOrders(e,t){return this.makeRequest("get","/v1/Orders",e||!0,x({},t))}async getOrder(e,t){return this.makeRequest("get",`/v1/Orders/${e}`,t||!0)}async cancelOrder(e,t,r,o){return this.makeRequest("delete",`/v1/Orders/${e}`,o||!0,{symbol:t,side:r}).then(i=>i.result)}async addSwapRequisites(e,t){return this.makeRequest("post",`/v1/Swaps/${e}/requisites`,(t==null?void 0:t.receivingAddress)||!0,{},t).then(r=>r.result)}async getSwaps(e,t){return this.makeRequest("get","/v1/Swaps",e||!0,x({},t))}async getSwap(e,t){return this.makeRequest("get",`/v1/Swaps/${e}`,t||!0)}getOrderPreview(e,t,r,o){let i=e.entries.filter(m=>m.side==t?!1:(()=>{switch(t+o){case"BuySend":case"SellReceive":return r/m.price;default:return r}})()<=Math.max(...m.qtyProfile)).map(m=>m.price);if(i.length==0)throw new Error(`No matching order found (${o} ${r} / ${t})`);let a=t=="Buy"?Math.min(...i):Math.max(...i),c=()=>{switch(t+o){case"BuySend":case"SellReceive":return r/a;default:return r*a}};return{price:a,amountSent:o=="Send"?r:c(),amountReceived:o=="Receive"?r:c()}}splitSymbol(e){let[t,r]=e.split("/",2);if(!t||!r)throw new Error("Symbol is invalid");return[t,r]}getCurrencyConfig(e){let t=Object.entries(u.currencies).find(([r,o])=>r==e);if(t==null)throw new Error(`No matching config section for ${e}`);return{blockchain:t[1].blockchain,decimals:t[1].decimals.original,displayDecimals:t[1].decimals.displayed,contractAddress:t[1].contracts[this._network].address,tokenAddress:t[1].contracts[this._network].tokenAddress}}formatAmount(e,t){let r=this.getCurrencyConfig(t);return parseFloat(typeof e=="string"?parseFloat(e).toFixed(r.displayDecimals):e.toFixed(r.displayDecimals))}getOrderSide(e,t,r){let[o,i]=this.splitSymbol(e);if(o===t&&i===r)return"Sell";if(i===t&&o===r)return"Buy";throw new Error(`Mismatch ${t} => ${r} (${e})`)}getMaxOrderSize(e,t){return Math.max(...e.entries.filter(r=>r.side!=t).map(r=>Math.max(...r.qtyProfile)))}};import At from"bignumber.js";import cn from"elliptic";import mn from"web3";var xe=class{constructor(e){this.atomex=e}validateInitiateTransactionBySwap(e){let t=e.counterParty.transactions.find(o=>o.type==="Lock");if(!t)return Promise.resolve({status:"NotFound",confirmations:0,nextBlockETA:0});let r=this.atomex.getCurrency(e.to.currencyId);if(!r)throw new Error(`Config of the "${e.to.currencyId}" not found`);return this.validateInitiateTransaction(t.blockId,t.id,e.secretHash,e.user.requisites.receivingAddress,k.tokensAmountToNat(e.to.amount,r.decimals),k.tokensAmountToNat(e.user.requisites.rewardForRedeem,r.decimals),0,2)}},te=n=>Math.round(new Date(n).getTime()/1e3),ct=()=>Math.round(Date.now()/1e3);var mt=class extends xe{constructor(t,r,o,i,a,c,m,d){super(t);s(this,"_web3");s(this,"_contract");s(this,"_timeBetweenBlocks");s(this,"_functions");s(this,"_initiateGasLimitWithoutReward");s(this,"_initiateGasLimitWithReward");s(this,"_redeemGasLimit");this._web3=r,this._contract=this.createContract(o,i),this._timeBetweenBlocks=a,this._initiateGasLimitWithoutReward=c,this._initiateGasLimitWithReward=m,this._redeemGasLimit=d,this._functions=new Map,this.initializeFunctions(o)}initializeFunctions(t){t.forEach(r=>{r.type==="function"&&this._functions.set(r.name,{types:r.inputs,signature:this._web3.eth.abi.encodeFunctionSignature(r)})})}static async create(t,r,o){let i=u.blockchains.ethereum.rpc[r];o!==void 0&&(i.rpc=o);let a=new mn(i.rpc),c=await a.eth.getChainId();if(i.chainID!==c)throw new Error(`Wrong chain ID: expected ${i.chainID}, actual ${c}`);return new mt(t,a,u.currencies.ETH.contracts.abi,u.currencies.ETH.contracts[r].address,i.blockTime,u.currencies.ETH.contracts[r].initiateGasLimitWithoutReward,u.currencies.ETH.contracts[r].initiateGasLimitWithReward,u.currencies.ETH.contracts[r].redeemGasLimit)}getAuthMessage(t,r){let o=Date.now();return{message:t,timestamp:o,msgToSign:t+o.toString(),algorithm:"Keccak256WithEcdsa:Geth2940"}}buildInitiateTransaction(t){if(t.refundTimestamp<ct())throw new Error(`Swap timestamp is in the past: ${t.refundTimestamp}`);return{data:this._contract.methods.initiate("0x"+t.secretHash,t.receivingAddress,t.refundTimestamp,t.rewardForRedeem.toString(10)).encodeABI(),contractAddr:this._contract.options.address,amount:t.netAmount.plus(t.rewardForRedeem)}}buildRedeemTransaction(t,r){return{data:this._contract.methods.redeem(r,t).encodeABI(),contractAddr:this._contract.options.address}}buildRefundTransaction(t){return{data:this._contract.methods.refund(t).encodeABI(),contractAddr:this._contract.options.address}}buildActivateTransaction(t){return{data:this._contract.methods.activate(t).encodeABI(),contractAddr:this._contract.options.address}}parseInitiateParameters(t){let r=this._functions.get("initiate");if(!t.input.startsWith(r.signature))throw new Error(`Unexpected method signature: ${t.input}`);let o=this._web3.eth.abi.decodeParameters(r.types,t.input.slice(r.signature.length));return{secretHash:o._hashedSecret.slice(2),receivingAddress:o._participant,refundTimestamp:parseInt(o._refundTimestamp),rewardForRedeem:new At(this._web3.utils.toBN(o._payoff).toString()),netAmount:new At(this._web3.utils.toBN(t.value).sub(this._web3.utils.toBN(o._payoff)).toString())}}async validateInitiateTransaction(t,r,o,i,a,c,m,d=2){var h;a=new At(a),c=new At(c);let l=a.minus(c),p=await this.getTransaction(r);try{if(!p)throw new Error(`Failed to retrieve transaction: ${r}`);let y=[];((h=p.to)==null?void 0:h.toLowerCase())!==this._contract.options.address.toLowerCase()&&y.push(`Wrong contract address: expect ${this._contract.options.address}, actual ${p.to}`);let w=this.parseInitiateParameters(p);if(w.secretHash!==o&&y.push(`Secret hash: expect ${o}, actual ${w.secretHash}`),w.receivingAddress.toLowerCase()!==i.toLowerCase()&&y.push(`Receiving address: expect ${i}, actual ${w.receivingAddress}`),w.netAmount.isEqualTo(l)||y.push(`Net amount: expect ${l.toString(10)}, actual ${w.netAmount.toString(10)}`),w.refundTimestamp<m&&y.push(`Refund timestamp: minimum ${m}, actual ${w.refundTimestamp}`),y.length){let C=y.reduce((f,Ct,Mt)=>`${f}
	${Mt+1}. ${Ct};`,`Initiate transaction that satisfies the expected criteria is not found in ${r} contents:`);throw new Error(C)}}catch(y){return{status:"Invalid",message:y.message,confirmations:0,nextBlockETA:0}}let v=await this.getBlock("latest"),P=v.number-(p.blockNumber||v.number),T={status:p.blockNumber!==void 0?"Included":"Pending",confirmations:P,nextBlockETA:parseInt(v.timestamp.toString())+this._timeBetweenBlocks};return P>=d&&(T.status="Confirmed"),T}hexSlice(t,r,o){return"0x"+o.slice(t*2+2,r*2+2)}getVRS(t){let r=[this.hexSlice(64,(t.length-2)/2,t),this.hexSlice(0,32,t),this.hexSlice(32,64,t)];return{v:parseInt(r[0].slice(2),16),r:r[1].slice(2),s:r[2].slice(2)}}recoverPublicKey(t,r){let o=this._web3.eth.accounts.hashMessage(t),i=this.getVRS(r),c=new cn.ec("secp256k1").recoverPubKey(Buffer.from(o.slice(2),"hex"),i,i.v<2?i.v:1-i.v%2);return"0x"+c.encode("hex",!1)}encodePublicKey(t){return t.startsWith("0x")?t.slice(2):t}encodeSignature(t){let r=this.getVRS(t);return r.r.padStart(64,"0")+r.s.padStart(64,"0")}async estimateInitiateFees(t){let r=await this._web3.eth.getGasPrice();return parseInt(r)*this._initiateGasLimitWithReward*1.2}async estimateRedeemFees(t){let r=await this._web3.eth.getGasPrice(),o=parseInt(r)*this._redeemGasLimit;return{totalCost:o,rewardForRedeem:2*o}}isValidAddress(t){return this._web3.utils.isAddress(t)}getTransaction(t){return this._web3.eth.getTransaction(t)}getBlock(t){return this._web3.eth.getBlock(t)}createContract(t,r){return new this._web3.eth.Contract(t,r)}};import{ParameterSchema as dn}from"@taquito/michelson-encoder";import{OpKind as ln}from"@taquito/rpc";import{TezosToolkit as pn}from"@taquito/taquito";import{b58cdecode as Tt,prefix as dt,validateAddress as un,ValidationResult as hn}from"@taquito/utils";import _e from"bignumber.js";var yn=n=>new Date(n*1e3).toISOString().slice(0,-5)+"Z",$=class extends xe{constructor(t,r,o,i,a,c,m,d,l,p,v,P){super(t);s(this,"_tezos");s(this,"_contractAddress");s(this,"_timeBetweenBlocks");s(this,"_entrypoints");s(this,"_gasLimit");s(this,"_minimalFees");s(this,"_minimalNanotezPerGasUnit");s(this,"_minimalNanotezPerByte");s(this,"_costPerByte");s(this,"_redeemTxSize");s(this,"_initiateTxSize");this._tezos=r,this._contractAddress=i,this._timeBetweenBlocks=a,this._gasLimit=c,this._minimalFees=m,this._minimalNanotezPerGasUnit=d,this._minimalNanotezPerByte=l,this._costPerByte=p,this._redeemTxSize=v,this._initiateTxSize=P,this._entrypoints=new Map(Object.entries(o).map(([T,h])=>[T,new dn(h)]))}static async create(t,r,o="XTZ",i){let a=u.blockchains.tezos.rpc[r];i!==void 0&&(a.rpc=i);let c=new pn(a.rpc),m=await c.rpc.getChainId();if(a.chainID!==m.toString())throw new Error(`Wrong chain ID: expected ${a.chainID}, actual ${m}`);return new $(t,c,u.currencies[o].contracts.entrypoints,u.currencies[o].contracts[r].address,u.blockchains.tezos.rpc[r].blockTime,u.currencies[o].contracts[r].gasLimit,u.blockchains.tezos.rpc[r].minimalFees,u.blockchains.tezos.rpc[r].minimalNanotezPerGasUnit,u.blockchains.tezos.rpc[r].minimalNanotezPerByte,u.blockchains.tezos.rpc[r].costPerByte,u.currencies[o].contracts[r].redeemTxSize,u.currencies[o].contracts[r].initiateTxSize)}getTezosAlgorithm(t){switch(t){case"tz1":return"Ed25519:Blake2b";case"tz2":return"Blake2bWithEcdsa:Secp256k1";case"tz3":return"Blake2bWithEcdsa:Secp256r1";default:throw new Error(`Unexpected address prefix: ${t}`)}}getAuthMessage(t,r){let o=Date.now();return{message:t,timestamp:o,msgToSign:t+o.toString(),algorithm:this.getTezosAlgorithm(r.slice(0,3))}}buildInitiateTransaction(t){var o;if(t.refundTimestamp<ct())throw new Error(`Swap timestamp is in the past: ${t.refundTimestamp}`);let r=(o=this._entrypoints.get("initiate"))==null?void 0:o.Encode(t.receivingAddress,t.secretHash,yn(t.refundTimestamp),t.rewardForRedeem);return{data:{entrypoint:"initiate",value:r},contractAddr:this._contractAddress,amount:t.netAmount.plus(t.rewardForRedeem)}}buildRedeemTransaction(t,r=""){var o;return{data:{entrypoint:"redeem",value:(o=this._entrypoints.get("redeem"))==null?void 0:o.Encode(t)},contractAddr:this._contractAddress}}buildRefundTransaction(t){var r;return{data:{entrypoint:"refund",value:(r=this._entrypoints.get("refund"))==null?void 0:r.Encode(t)},contractAddr:this._contractAddress}}getBlockDetails(t){return{level:t.metadata.level_info.level,timestamp:te(t.header.timestamp)}}parseInitiateParameters(t){var i;if(t.parameters===void 0)throw new Error("Parameters are undefined");let r=(i=this._entrypoints.get(t.parameters.entrypoint))==null?void 0:i.Execute(t.parameters.value);if(r===void 0)throw new Error(`Unexpected entrypoint: ${t.parameters.entrypoint}`);let o=(()=>{switch(t.parameters.entrypoint){case"initiate":return r;case"fund":case"default":return r.initiate;default:throw new Error(`Unexpected entrypoint: ${t.parameters.entrypoint}`)}})();return{secretHash:o.settings.hashed_secret,receivingAddress:o.participant,refundTimestamp:te(o.settings.refund_time),netAmount:new _e(t.amount).minus(o.settings.payoff),rewardForRedeem:new _e(o.settings.payoff)}}findContractCall(t,r){var a;let o=(a=t.operations[3])==null?void 0:a.find(c=>c.hash==r);if(o===void 0)throw new Error(`Operation not found: ${r} @ ${t.hash}`);let i=o.contents.filter(c=>c.kind=="transaction"&&c.destination==this._contractAddress);if(i.length===0)throw new Error("Unsupported contract version is used");return i}async validateInitiateTransaction(t,r,o,i,a,c,m,d=2){a=new _e(a),c=new _e(c);let l=a.minus(c),p=await this.getBlock(t);try{let y=[];if(!this.findContractCall(p,r).find(C=>{y=[];let f=this.parseInitiateParameters(C);return f.secretHash!==o&&y.push(`Secret hash: expect ${o}, actual ${f.secretHash}. Counter = ${C.counter}`),f.receivingAddress.toLowerCase()!==i.toLowerCase()&&y.push(`Receiving address: expect ${i}, actual ${f.receivingAddress}. Counter = ${C.counter}`),f.netAmount.isEqualTo(l)||y.push(`Net amount: expect ${l.toString(10)}, actual ${f.netAmount.toString(10)}. Counter = ${C.counter}`),f.refundTimestamp<m&&y.push(`Refund timestamp: minimum ${m}, actual ${f.refundTimestamp}. Counter = ${C.counter}`),!y.length},this)){let C=y.reduce((f,Ct,Mt)=>`${f}
	${Mt+1}. ${Ct};`,`Initiate transaction that satisfies the expected criteria is not found in ${r} contents:`);throw new Error(C)}}catch(y){return{status:"Invalid",message:y.message,confirmations:0,nextBlockETA:0}}let v=this.getBlockDetails(await this.getBlock("head")),P=this.getBlockDetails(p),T=v.level-P.level,h={status:"Included",confirmations:T,nextBlockETA:v.timestamp+this._timeBetweenBlocks};return T>=d&&(h.status="Confirmed"),h}encodePublicKey(t){switch(t.substring(0,2)){case"ed":return Buffer.from(Tt(t,dt.edpk)).toString("hex");case"p2":return Buffer.from(Tt(t,dt.p2pk)).toString("hex");case"sp":return Buffer.from(Tt(t,dt.sppk)).toString("hex");default:throw new Error("Unsupported Public Key Type")}}encodeSignature(t){var o;let r=t.startsWith("sig")?t.substring(0,3):t.substring(0,5);if(Object.prototype.hasOwnProperty.call(dt,r))return Buffer.from(Tt(t,(o=Object.getOwnPropertyDescriptor(dt,r))==null?void 0:o.value)).toString("hex");throw new Error("Unsupported Signature Type")}calcFees(t=0,r=0,o=0){return this._minimalFees+this._minimalNanotezPerGasUnit*t+this._minimalNanotezPerByte*o+r*this._costPerByte}async estimateInitiateFees(t){let r={receivingAddress:"tz1Q2prWCrDGFDuGTe7axdt4z9e3QkCqdhmD",secretHash:"169cbd29345af89a0983f28254e71bdd1367890b9876fc8a9ea117c32f6a521b",refundTimestamp:2147483647,rewardForRedeem:new _e(0),netAmount:new _e(100)},o=this.buildInitiateTransaction(r),i=await this._tezos.rpc.getBlockHeader(),a=await this._tezos.rpc.getContract(t),c=await this._tezos.rpc.runOperation({chain_id:i.chain_id,operation:{branch:i.hash,signature:"sigUHx32f9wesZ1n2BWpixXz4AQaZggEtchaQNHYGRCoWNAXx45WGW2ua3apUUUAGMLPwAU41QoaFCzVSL61VaessLg4YbbP",contents:[{amount:"0",counter:(parseInt(a.counter||"0")+1).toString(),destination:this._contractAddress,fee:this.calcFees(104e4,6e4,this._initiateTxSize).toString(),gas_limit:"1040000",kind:ln.TRANSACTION,source:t,storage_limit:"60000",parameters:o.data}]}}),m=0,d=0;return c.contents.forEach(l=>{if(l.metadata.operation_result.status!=="applied")throw new Error("Some error was encountered while estimating fees");d+=parseInt(l.metadata.operation_result.consumed_gas||"0"),m+=parseInt(l.metadata.operation_result.paid_storage_size_diff||"0")}),this.calcFees(d,m,this._initiateTxSize)}async estimateRedeemFees(t){let r=this.calcFees(this._gasLimit,0,this._redeemTxSize);return await this._tezos.rpc.getManagerKey(t)===null&&(r+=257*this._costPerByte),{totalCost:r,rewardForRedeem:2*r}}isValidAddress(t){return un(t)==hn.VALID}getBlock(t){return this._tezos.rpc.getBlock({block:t.toString()})}};import{TezosToolkit as gn}from"@taquito/taquito";import Ur from"bignumber.js";var lt=class extends ${static async create(e,t,r,o){let i=u.blockchains.tezos.rpc[t];o!==void 0&&(i.rpc=o);let a=new gn(i.rpc),c=await a.rpc.getChainId();if(i.chainID!==c.toString())throw new Error(`Wrong chain ID: expected ${i.chainID}, actual ${c}`);return new lt(e,a,u.currencies[r].contracts.entrypoints,u.currencies[r].contracts[t].address,u.blockchains.tezos.rpc[t].blockTime,u.currencies[r].contracts[t].gasLimit,u.blockchains.tezos.rpc[t].minimalFees,u.blockchains.tezos.rpc[t].minimalNanotezPerGasUnit,u.blockchains.tezos.rpc[t].minimalNanotezPerByte,u.blockchains.tezos.rpc[t].costPerByte,u.currencies[r].contracts[t].redeemTxSize,u.currencies[r].contracts[t].initiateTxSize)}parseInitiateParameters(e){var o;if(e.parameters===void 0)throw new Error("Parameters are undefined");let t=(o=this._entrypoints.get(e.parameters.entrypoint))==null?void 0:o.Execute(e.parameters.value);if(t===void 0)throw new Error(`Unexpected entrypoint: ${e.parameters.entrypoint}`);let r=(()=>{switch(e.parameters.entrypoint){case"initiate":return t;case"default":return t.initiate;default:throw new Error(`Unexpected entrypoint: ${e.parameters.entrypoint}`)}})();return{secretHash:r.hashedSecret,receivingAddress:r.participant,refundTimestamp:te(r.refundTime),netAmount:new Ur(r.totalAmount).minus(r.payoffAmount),rewardForRedeem:new Ur(r.payoffAmount)}}};import{TezosToolkit as fn}from"@taquito/taquito";import Lr from"bignumber.js";var pt=class extends ${static async create(e,t,r,o){let i=u.blockchains.tezos.rpc[t];o!==void 0&&(i.rpc=o);let a=new fn(i.rpc),c=await a.rpc.getChainId();if(i.chainID!==c.toString())throw new Error(`Wrong chain ID: expected ${i.chainID}, actual ${c}`);return new pt(e,a,u.currencies[r].contracts.entrypoints,u.currencies[r].contracts[t].address,u.blockchains.tezos.rpc[t].blockTime,u.currencies[r].contracts[t].gasLimit,u.blockchains.tezos.rpc[t].minimalFees,u.blockchains.tezos.rpc[t].minimalNanotezPerGasUnit,u.blockchains.tezos.rpc[t].minimalNanotezPerByte,u.blockchains.tezos.rpc[t].costPerByte,u.currencies[r].contracts[t].redeemTxSize,u.currencies[r].contracts[t].initiateTxSize)}parseInitiateParameters(e){var o;if(!e.parameters)throw new Error("Parameters are undefined");let t=(o=this._entrypoints.get(e.parameters.entrypoint))==null?void 0:o.Execute(e.parameters.value);if(!t)throw new Error(`Unexpected entrypoint: ${e.parameters.entrypoint}`);let r=this.getInitiateParams(e.parameters.entrypoint,t);return{secretHash:r.hashedSecret,receivingAddress:r.participant,refundTimestamp:te(r.refundTime),netAmount:new Lr(r.totalAmount).minus(r.payoffAmount),rewardForRedeem:new Lr(r.payoffAmount)}}getInitiateParams(e,t){switch(e){case"initiate":return t;case"default":return t.initiate;default:throw new Error(`Unexpected entrypoint: ${e}`)}}};export{Pe as Atomex,fe as AtomexBuilder,ot as AuthTokenSource,L as AuthorizationManager,oe as DataSource,ye as DefaultSerializedAuthTokenMapper,j as ERC20EthereumWeb3AtomexProtocolMultiChain,Q as EthereumWeb3AtomexProtocolMultiChain,ve as ExchangeManager,X as FA12TezosTaquitoAtomexProtocolMultiChain,J as FA2TezosTaquitoAtomexProtocolMultiChain,qe as ImportantDataReceivingMode,Fe as InMemoryAuthorizationManagerStore,ie as InMemoryExchangeSymbolsProvider,ge as LocalStorageAuthorizationManagerStore,Re as MixedApiAtomexClient,pe as RestAtomexClient,de as TaquitoBlockchainWallet,V as TezosTaquitoAtomexProtocolMultiChain,Te as WalletsManager,Ce as Web3BlockchainWallet,he as WebSocketAtomexClient,R as atomexUtils,k as converters,Dr as createDefaultMainnetAtomex,qr as createDefaultTestnetAtomex,we as guards,rr as legacy,Et as prepareTimeoutDuration,De as textUtils,Tn as wait};
//# sourceMappingURL=index.js.map
